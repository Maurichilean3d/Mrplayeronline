<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>MR Studio Diamond v7.0 MASTER Edition (Triple Chroma + Real Occlusion)</title>
  <script src="https://unpkg.com/omggif@1.0.10/omggif.js"></script>
  <style>
    * { box-sizing: border-box; user-select: none; }
    body { margin: 0; overflow: hidden; background: transparent; font-family: 'Segoe UI', system-ui, sans-serif; color: #eee; }
    #c { position: fixed; inset: 0; width: 100%; height: 100%; touch-action: none; z-index: 0; }
    
    .ui-panel { 
      position: fixed; left: 20px; top: 20px; width: 440px; max-height: 95vh; 
      background: rgba(10, 10, 14, 0.96); backdrop-filter: blur(25px); 
      border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 18px; 
      padding: 20px; overflow-y: auto; z-index: 100; 
      box-shadow: 0 25px 60px rgba(0,0,0,0.85); 
    }
    .ui-panel.hidden { transform: translateX(-480px); }
    
    h2 { margin: 0 0 18px 0; font-size: 20px; color: #a29bfe; font-weight: 900; text-transform: uppercase; border-bottom: 2px solid rgba(108, 92, 231, 0.3); padding-bottom: 10px; }
    .sec-head { font-size: 11px; font-weight: 800; color: #b2b9c6; margin: 18px 0 10px 0; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
    
    .row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    label { font-size: 12px; flex: 1; color: #d1d5db; white-space: nowrap; font-weight: 500; }
    input[type=range] { flex: 2; height: 5px; accent-color: #6c5ce7; cursor: pointer; }
    .val { width: 50px; text-align: right; font-size: 11px; font-family: 'Consolas', monospace; color: #a29bfe; font-weight: 600; }
    
    select, input[type=file], input[type=url] { width: 100%; background: #1e1e24; border: 1px solid #444; color: #eee; padding: 10px; border-radius: 10px; font-size: 11px; outline: none; }
    
    button { flex: 1; padding: 13px; border-radius: 10px; border: none; font-size: 12px; font-weight: 800; cursor: pointer; color: white; background: #2a2d35; transition: 0.25s; }
    button.primary { background: linear-gradient(135deg, #6c5ce7, #a29bfe); }
    button.danger { background: rgba(255, 71, 87, 0.2); color: #ff7675; border: 1px solid #ff4757; }
    button.success { background: rgba(85, 239, 196, 0.2); color: #55efc4; border: 1px solid #55efc4; }

    .preset-grid { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
    .preset-item { width: 34px; height: 34px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; display: grid; place-items: center; font-size: 18px; transition: 0.2s; }
    .preset-item:hover { transform: scale(1.1); border-color: #6c5ce7; }

    .layer-list { max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.4); border-radius: 10px; padding: 6px; margin-bottom: 12px; }
    .layer-item { padding: 10px; font-size: 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; background: rgba(255,255,255,0.02); }
    .layer-item.active { background: rgba(108, 92, 231, 0.3); border: 1px solid #6c5ce7; }

    #vrBtn { position: fixed; bottom: 35px; left: 50%; transform: translateX(-50%); padding: 16px 50px; background: linear-gradient(135deg, #6c5ce7, #0984e3); color: white; border-radius: 60px; font-weight: 900; z-index: 1000; display: none; box-shadow: 0 0 25px rgba(108,92,231,0.5); }
    .loader { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; place-items: center; flex-direction: column; color: #a29bfe; font-weight: 900; }
  </style>
</head>
<body>

<canvas id="c"></canvas>
<div class="loader" id="loader"><span>CARGANDO DIAMOND v7.0...</span></div>

<div class="ui-panel" id="ui">
  <h2>ü•Ω MR Studio v7.0 DIAMOND</h2>

  <div class="sec-head">üåê Carga Web</div>
  <div class="row">
    <input type="url" id="webUrl" placeholder="URL directa (.mp4, .jpg, .glb)">
    <button class="primary" onclick="loadFromWeb()" style="width:70px;">ADD</button>
  </div>

  <div class="sec-head">üìÇ Archivos Locales</div>
  <input type="file" id="fileInput" multiple style="display:none;">
  <button class="success" onclick="document.getElementById('fileInput').click()">üìÅ IMPORTAR ARCHIVOS</button>

  <div class="sec-head">Capas</div>
  <div id="layerList" class="layer-list"></div>

  <div id="editorUI" style="display:none;">
    <div class="sec-head">üß≠ Configuraci√≥n MR</div>
    <div class="row"><label><input type="checkbox" id="checkOcclusion"> Oclusi√≥n Real (Depth API)</label></div>
    
    <div class="sec-head">üìè Transformaci√≥n</div>
    <div class="row"><label>Escala</label><input type="range" id="scale" min="0.01" max="30" step="0.01" value="1"><span class="val" id="v_scale">1.0</span></div>
    <div class="row"><label>Altura (Y)</label><input type="range" id="posY" min="-10" max="10" step="0.1" value="1.6"><span class="val" id="v_posY">1.6</span></div>
    <div class="row"><label>Posici√≥n Z</label><input type="range" id="posZ" min="-30" max="30" step="0.1" value="-2"><span class="val" id="v_posZ">-2.0</span></div>
    <div class="row"><label>Rotaci√≥n Y</label><input type="range" id="rotY" min="0" max="360" step="1" value="0"><span class="val" id="v_rotY">0</span></div>

    <div class="sec-head">üåê Proyecci√≥n</div>
    <select id="projSelect" onchange="updateProjection()">
      <option value="plane">Plano 2D</option>
      <option value="360">360¬∞ Interior (Inmersivo)</option>
      <option value="orb">360¬∞ Exterior (Orbe)</option>
      <option value="180">Domo 180¬∞</option>
    </select>

    <div class="sec-head">üé≠ Chroma Key Ultra Pro</div>
    <div class="row"><label>Activar Chroma</label><input type="checkbox" id="chromaToggle"></div>
    <div id="chromaPanel" style="display:none; background:rgba(0,0,0,0.3); padding:12px; border-radius:12px;">
        <div class="preset-grid">
            <div class="preset-item" data-color="0,1,0" style="background:#0f0;">üü¢</div>
            <div class="preset-item" data-color="0,0,1" style="background:#00f;">üîµ</div>
            <div class="preset-item" data-color="1,0,0" style="background:#f00;">üî¥</div>
            <div class="preset-item" data-color="0,0,0" style="background:#000; border:1px solid #555;">‚ö´</div>
        </div>
        <div class="row"><label>R,G,B</label>
          <input type="range" id="k1r" min="0" max="1" step="0.01" value="0">
          <input type="range" id="k1g" min="0" max="1" step="0.01" value="1">
          <input type="range" id="k1b" min="0" max="1" step="0.01" value="0">
        </div>
        <div id="colorPrev" style="height:10px; width:100%; border-radius:6px; margin:8px 0; border:1px solid #555;"></div>
        <div class="row"><label>Similitud</label><input type="range" id="k1sim" min="0" max="1" step="0.001" value="0.4"></div>
        <div class="row"><label>Suavizado</label><input type="range" id="k1smooth" min="0" max="0.5" step="0.001" value="0.08"></div>
    </div>
  </div>

  <div style="margin-top:20px; display:flex; gap:10px;">
    <button class="danger" onclick="deleteActive()">üóëÔ∏è Borrar</button>
    <button onclick="centerActive()">üéØ Centrar</button>
  </div>
</div>

<button id="vrBtn">ENTRAR EN MR</button>

<script type="importmap">
{ "imports": {
  "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
  "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
} }
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { TransformControls } from 'three/addons/controls/TransformControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

// --- DEPTH SHADER (RESTORED v6) ---
const depthVS = `#version 300 es
precision highp float;
in vec2 aPos; out vec2 vUv;
void main(){ vUv = aPos * 0.5 + 0.5; gl_Position = vec4(aPos, 0.0, 1.0); }`;

const depthFS = `#version 300 es
precision highp float;
precision highp sampler2D;
in vec2 vUv;
uniform sampler2D uDepth;
uniform float uRawToMeters;
uniform mat4 uProj;
out vec4 outColor;
float decodeRaw(vec4 la){ return (la.r * 255.0 * 256.0 + la.a * 255.0); }
void main(){
  vec4 la = texture(uDepth, vUv);
  float zMeters = decodeRaw(la) * uRawToMeters;
  if(zMeters <= 0.0) discard;
  float z = -zMeters;
  float clipZ = uProj[2][2] * z + uProj[3][2];
  float clipW = uProj[2][3] * z + uProj[3][3];
  gl_FragDepth = clamp((clipZ / clipW) * 0.5 + 0.5, 0.0, 1.0);
  outColor = vec4(0.0);
}`;

// --- CHROMA SHADER DIAMOND ---
const vShader = `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`;
const fShader = `
uniform sampler2D map;
uniform bool chromaOn;
uniform vec3 k1; uniform float sim1; uniform float smooth1;
varying vec2 vUv;
void main() {
  vec4 tex = texture2D(map, vUv);
  float alpha = tex.a;
  if(chromaOn) {
    float d = distance(tex.rgb, k1);
    alpha = smoothstep(sim1, sim1 + smooth1, d);
  }
  gl_FragColor = vec4(tex.rgb, alpha);
  if(alpha < 0.01) discard;
}`;

let scene, camera, renderer, orbit, transformCtrl, xrSession, xrRefSpace;
let objects = [], activeId = null;
let xrGlBinding = null, depthProgram = null, depthVao = null, depthTex = null;
let occlusionEnabled = false;

function init() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 2000);
  camera.position.set(0, 1.6, 3);

  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('c'), antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;

  orbit = new OrbitControls(camera, renderer.domElement);
  orbit.target.set(0, 1.6, 0);

  transformCtrl = new TransformControls(camera, renderer.domElement);
  transformCtrl.addEventListener('dragging-changed', e => orbit.enabled = !e.value);
  scene.add(transformCtrl);

  scene.add(new THREE.AmbientLight(0xffffff, 1.5));
  
  setupVR();
  initPresets();
  renderer.setAnimationLoop(animate);
}

// --- DEPTH HANDLER ---
function initDepthOcclusion(session) {
  const gl = renderer.getContext();
  xrGlBinding = new XRWebGLBinding(session, gl);
  const vs = gl.createShader(gl.VERTEX_SHADER); gl.shaderSource(vs, depthVS); gl.compileShader(vs);
  const fs = gl.createShader(gl.FRAGMENT_SHADER); gl.shaderSource(fs, depthFS); gl.compileShader(fs);
  depthProgram = gl.createProgram(); gl.attachShader(depthProgram, vs); gl.attachShader(depthProgram, fs); gl.linkProgram(depthProgram);
  depthVao = gl.createVertexArray(); gl.bindVertexArray(depthVao);
  const vbo = gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER, vbo);
  gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 1,-1, -1,1, -1,1, 1,-1, 1,1]), gl.STATIC_DRAW);
  const loc = gl.getAttribLocation(depthProgram, 'aPos'); gl.enableVertexAttribArray(loc); gl.vertexAttribPointer(loc, 2, gl.FLOAT, false, 0, 0);
  depthTex = gl.createTexture();
}

// --- ASSET LOADER (GIF FIXED) ---
async function addAsset(url, type, name, isGif = false) {
  toggleLoader(true);
  let tex, mesh, gifData = null, video = null;

  try {
    if (isGif) {
      const resp = await fetch(url);
      const buf = await resp.arrayBuffer();
      const reader = new window.Omggif.GifReader(new Uint8Array(buf));
      const cvs = document.createElement('canvas');
      cvs.width = reader.width; cvs.height = reader.height;
      const ctx = cvs.getContext('2d');
      const imgData = ctx.createImageData(cvs.width, cvs.height);
      tex = new THREE.CanvasTexture(cvs);
      gifData = { reader, ctx, imgData, tex, frame: 0, nextTime: 0 };
    } else if (type === 'video') {
      video = document.createElement('video');
      video.src = url;
      video.loop = true; video.muted = true; video.crossOrigin = "anonymous";
      video.setAttribute('playsinline', '');
      await video.play();
      tex = new THREE.VideoTexture(video);
    } else {
      tex = await new THREE.TextureLoader().loadAsync(url);
    }

    const mat = new THREE.ShaderMaterial({
      uniforms: { map: { value: tex }, chromaOn: { value: false }, k1: { value: new THREE.Color(0,1,0) }, sim1: { value: 0.4 }, smooth1: { value: 0.08 } },
      vertexShader: vShader, fragmentShader: fShader, transparent: true, side: THREE.DoubleSide
    });

    const aspect = video ? video.videoWidth/video.videoHeight : (tex.image ? tex.image.width/tex.image.height : 1.77);
    mesh = new THREE.Mesh(new THREE.PlaneGeometry(aspect * 2, 2), mat);
    mesh.position.set(0, 1.6, -2);
    
    const obj = { id: Math.random().toString(36).substr(2,9), name, mesh, video, gifData, type };
    objects.push(obj);
    scene.add(mesh);
    selectObject(obj.id);
    updateLayers();
  } catch (e) { console.error(e); }
  toggleLoader(false);
}

function animate(time, frame) {
  if (frame && occlusionEnabled && xrGlBinding) {
    const pose = frame.getViewerPose(xrRefSpace);
    if (pose) {
      const gl = renderer.getContext();
      gl.colorMask(false, false, false, false);
      for (const view of pose.views) {
        const depthInfo = xrGlBinding.getDepthInformation(view);
        if (depthInfo) {
           gl.bindTexture(gl.TEXTURE_2D, depthTex);
           gl.texImage2D(gl.TEXTURE_2D, 0, gl.LUMINANCE_ALPHA, depthInfo.width, depthInfo.height, 0, gl.LUMINANCE_ALPHA, gl.UNSIGNED_BYTE, depthInfo.data);
           gl.useProgram(depthProgram);
           gl.uniform1f(gl.getUniformLocation(depthProgram, 'uRawToMeters'), depthInfo.rawValueToMeters);
           gl.uniformMatrix4fv(gl.getUniformLocation(depthProgram, 'uProj'), false, view.projectionMatrix);
           gl.bindVertexArray(depthVao);
           gl.drawArrays(gl.TRIANGLES, 0, 6);
        }
      }
      gl.colorMask(true, true, true, true);
    }
  }

  objects.forEach(obj => {
    if (obj.gifData) {
      const g = obj.gifData;
      if (performance.now() > g.nextTime) {
        g.reader.decodeAndBlitFrameRGBA(g.frame, g.imgData.data);
        g.ctx.putImageData(g.imgData, 0, 0);
        g.tex.needsUpdate = true;
        g.nextTime = performance.now() + (g.reader.frameInfo(g.frame).delay * 10 || 100);
        g.frame = (g.frame + 1) % g.reader.numFrames();
      }
    }
  });
  renderer.render(scene, camera);
}

// --- PROJECTION SYSTEM ---
window.updateProjection = () => {
  const obj = objects.find(o => o.id === activeId);
  if (!obj) return;
  const mode = document.getElementById('projSelect').value;
  scene.remove(obj.mesh);
  
  if (mode === '360') {
    obj.mesh.geometry = new THREE.SphereGeometry(100, 64, 32);
    obj.mesh.material.side = THREE.BackSide;
    obj.mesh.position.set(0, 0, 0);
  } else if (mode === 'orb') {
    obj.mesh.geometry = new THREE.SphereGeometry(2, 64, 32);
    obj.mesh.material.side = THREE.FrontSide;
    obj.mesh.position.set(0, 1.6, -3);
  } else if (mode === '180') {
    obj.mesh.geometry = new THREE.SphereGeometry(100, 64, 32, 0, Math.PI * 2, 0, Math.PI / 2);
    obj.mesh.material.side = THREE.BackSide;
  } else {
    obj.mesh.geometry = new THREE.PlaneGeometry(3, 1.8);
    obj.mesh.material.side = THREE.DoubleSide;
    obj.mesh.position.set(0, 1.6, -2);
  }
  scene.add(obj.mesh);
};

// --- LOGIC ---
window.loadFromWeb = () => {
  const url = document.getElementById('webUrl').value;
  if (!url) return;
  const isGif = url.toLowerCase().includes('.gif');
  const type = url.match(/\.(mp4|webm)/i) ? 'video' : 'image';
  addAsset(url, type, "Web", isGif);
};

document.getElementById('fileInput').onchange = (e) => {
  for (let f of e.target.files) {
    const url = URL.createObjectURL(f);
    const isGif = f.name.toLowerCase().endsWith('.gif');
    addAsset(url, f.type.includes('video') ? 'video' : 'image', f.name, isGif);
  }
};

function selectObject(id) {
  activeId = id;
  const obj = objects.find(o => o.id === id);
  if (obj) {
    transformCtrl.attach(obj.mesh);
    document.getElementById('editorUI').style.display = 'block';
    // Sync Sliders
    document.getElementById('scale').value = obj.mesh.scale.x;
    document.getElementById('posY').value = obj.mesh.position.y;
    document.getElementById('posZ').value = obj.mesh.position.z;
  }
  updateLayers();
}

function updateLayers() {
  const list = document.getElementById('layerList'); list.innerHTML = '';
  objects.forEach(o => {
    const d = document.createElement('div');
    d.className = `layer-item ${o.id === activeId ? 'active' : ''}`;
    d.innerHTML = `<span>${o.type === 'video' ? 'üé¨' : 'üñºÔ∏è'}</span> ${o.name.slice(0,18)}`;
    d.onclick = () => selectObject(o.id);
    list.appendChild(d);
  });
}

function initPresets() {
    document.querySelectorAll('.preset-item').forEach(el => {
        el.onclick = () => {
            const [r,g,b] = el.dataset.color.split(',').map(Number);
            document.getElementById('k1r').value = r;
            document.getElementById('k1g').value = g;
            document.getElementById('k1b').value = b;
            updateChroma();
        };
    });
}

const updateChroma = () => {
    const o = objects.find(o => o.id === activeId);
    if (!o) return;
    const r = document.getElementById('k1r').value;
    const g = document.getElementById('k1g').value;
    const b = document.getElementById('k1b').value;
    o.mesh.material.uniforms.k1.value.setRGB(r,g,b);
    o.mesh.material.uniforms.sim1.value = document.getElementById('k1sim').value;
    o.mesh.material.uniforms.smooth1.value = document.getElementById('k1smooth').value;
    document.getElementById('colorPrev').style.background = `rgb(${r*255},${g*255},${b*255})`;
};

['k1r','k1g','k1b','k1sim','k1smooth'].forEach(id => document.getElementById(id).oninput = updateChroma);

document.getElementById('chromaToggle').onchange = (e) => {
    const o = objects.find(o => o.id === activeId);
    if (o) {
        o.mesh.material.uniforms.chromaOn.value = e.target.checked;
        document.getElementById('chromaPanel').style.display = e.target.checked ? 'block' : 'none';
    }
};

function setupVR() {
  if (navigator.xr) {
    navigator.xr.isSessionSupported('immersive-ar').then(ok => {
      if (ok) {
        const btn = document.getElementById('vrBtn');
        btn.style.display = 'block';
        btn.onclick = async () => {
          occlusionEnabled = document.getElementById('checkOcclusion').checked;
          xrSession = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['local-floor'],
            optionalFeatures: ['dom-overlay', 'depth-sensing'],
            domOverlay: { root: document.body },
            depthSensing: { usagePreference: ['cpu-optimized'], dataFormatPreference: ['luminance-alpha'] }
          });
          renderer.xr.setSession(xrSession);
          xrRefSpace = renderer.xr.getReferenceSpace();
          if (occlusionEnabled) initDepthOcclusion(xrSession);
        };
      }
    });
  }
}

['scale','posY','posZ','rotY'].forEach(id => {
  document.getElementById(id).oninput = (e) => {
    const o = objects.find(o => o.id === activeId);
    if (!o) return;
    const v = parseFloat(e.target.value);
    if(id==='scale') o.mesh.scale.setScalar(v);
    if(id==='posY') o.mesh.position.y = v;
    if(id==='posZ') o.mesh.position.z = v;
    if(id==='rotY') o.mesh.rotation.y = v * (Math.PI/180);
    document.getElementById('v_'+id).innerText = v.toFixed(1);
  };
});

window.deleteActive = () => {
  const idx = objects.findIndex(o => o.id === activeId);
  if (idx > -1) {
    scene.remove(objects[idx].mesh);
    objects.splice(idx, 1);
    transformCtrl.detach();
    updateLayers();
  }
};

window.centerActive = () => {
  const o = objects.find(o => o.id === activeId);
  if(o) o.mesh.position.set(0, 1.6, -2);
};

function toggleLoader(s) { document.getElementById('loader').style.display = s ? 'grid' : 'none'; }

init();
</script>
</body>
</html>