<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>MR Studio Diamond v7.2 | Grid & Stats</title>
  <script src="https://unpkg.com/omggif@1.0.10/omggif.js"></script>
  <style>
    * { box-sizing: border-box; user-select: none; }
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', system-ui, sans-serif; color: #eee; }
    #c { position: fixed; inset: 0; width: 100%; height: 100%; touch-action: none; z-index: 0; }
    
    .ui-panel { 
      position: fixed; left: 20px; top: 20px; width: 360px; max-height: 90vh; 
      background: rgba(12, 12, 16, 0.95); backdrop-filter: blur(20px); 
      border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; 
      padding: 15px; overflow-y: auto; z-index: 100; 
      box-shadow: 0 20px 50px rgba(0,0,0,0.9);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .ui-panel.minimized { transform: translateX(-410px); }
    
    #toggleUI {
        position: fixed; left: 20px; top: 20px; z-index: 101;
        width: 40px; height: 40px; border-radius: 50%; background: #6c5ce7;
        border: none; color: white; cursor: pointer; display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5); font-weight: bold;
    }

    h2 { margin: 0 0 15px 0; font-size: 16px; color: #a29bfe; font-weight: 800; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;}
    .sec-head { font-size: 10px; font-weight: 800; color: #74b9ff; margin: 15px 0 8px 0; text-transform: uppercase; letter-spacing: 1px; }
    
    .row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    label { font-size: 11px; flex: 1; color: #ccc; }
    input[type=range] { flex: 2; height: 4px; accent-color: #6c5ce7; cursor: pointer; background: #333; border-radius: 2px; }
    input[type=checkbox] { width: 16px; height: 16px; accent-color: #6c5ce7; cursor: pointer; }
    .val { width: 40px; text-align: right; font-size: 10px; color: #a29bfe; font-family: monospace; }
    
    select, input[type=url] { width: 100%; background: #1e1e24; border: 1px solid #333; color: #eee; padding: 8px; border-radius: 6px; font-size: 11px; outline: none; }
    
    button { flex: 1; padding: 10px; border-radius: 6px; border: none; font-size: 11px; font-weight: 700; cursor: pointer; color: white; background: #2d3436; transition: 0.2s; }
    button:active { transform: scale(0.96); }
    button.primary { background: #6c5ce7; }
    button.danger { background: rgba(214, 48, 49, 0.2); color: #ff7675; border: 1px solid #d63031; }

    .layer-list { max-height: 100px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 5px; margin-bottom: 10px; border: 1px solid #333; }
    .layer-item { padding: 6px; font-size: 11px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-bottom: 2px; }
    .layer-item.active { background: rgba(108, 92, 231, 0.25); border-left: 3px solid #6c5ce7; }

    #vrBtn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 14px 40px; background: #6c5ce7; color: white; border-radius: 50px; font-weight: 800; z-index: 1000; display: none; box-shadow: 0 0 30px rgba(108,92,231,0.6); border: 2px solid white; }
    .loader { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; place-items: center; color: #a29bfe; font-weight: 900; }
  </style>
</head>
<body>

<canvas id="c"></canvas>
<div class="loader" id="loader">CARGANDO...</div>
<button id="toggleUI" onclick="toggleUIPanel()">‚ò∞</button>

<div class="ui-panel" id="ui">
  <h2>
      <span>üíé DIAMOND v7.2</span>
      <button style="width:auto; padding:4px 8px; background:transparent; font-size:16px;" onclick="toggleUIPanel()">√ó</button>
  </h2>

  <div class="sec-head">üì• Importar</div>
  <div class="row">
    <input type="url" id="webUrl" placeholder="URL .mp4, .gif, .png">
    <button class="primary" onclick="loadFromWeb()">ADD</button>
  </div>
  <button onclick="document.getElementById('fileInput').click()" style="width:100%; margin-top:5px;">üìÅ ABRIR LOCAL</button>
  <input type="file" id="fileInput" multiple style="display:none;">

  <div class="sec-head">üìè Referencias y Sistema</div>
  <div class="row">
    <label><input type="checkbox" id="checkGrid" checked> Grilla Arquitect√≥nica</label>
    <label><input type="checkbox" id="checkStats" checked> Mostrar Gr√°fica FPS</label>
  </div>

  <div class="sec-head">Capas</div>
  <div id="layerList" class="layer-list"></div>

  <div id="editorUI" style="display:none;">
    <div class="row">
        <input type="checkbox" id="checkBillboard"> 
        <label>BILLBOARD (Mirar a c√°mara)</label>
    </div>

    <div class="sec-head">‚ú® Propiedades</div>
    <div class="row"><label>Opacidad</label><input type="range" id="opacity" min="0" max="1" step="0.01" value="1"><span class="val" id="v_opacity">1.0</span></div>
    <div class="row"><label>Escala</label><input type="range" id="scale" min="0.01" max="10" step="0.01" value="1"><span class="val" id="v_scale">1.0</span></div>
    
    <div class="sec-head">üß™ Chroma Key</div>
    <div class="row"><label><input type="checkbox" id="chromaToggle"> Activar Chroma</label></div>
    <div id="chromaPanel" style="display:none; padding:8px; background:rgba(255,255,255,0.05); border-radius:8px;">
        <div class="row"><input type="color" id="pickerColor" value="#00ff00"><label>Color Key</label></div>
        <div class="row"><label>Similitud</label><input type="range" id="k1sim" min="0" max="0.8" step="0.001" value="0.4"></div>
    </div>
  </div>

  <div style="margin-top:15px; display:flex; gap:10px;">
    <button class="danger" onclick="deleteActive()">üóëÔ∏è ELIMINAR</button>
    <button onclick="centerActive()">üéØ CENTRAR</button>
  </div>
  
  <div class="sec-head">‚öôÔ∏è Global</div>
  <div class="row"><label><input type="checkbox" id="checkOcclusion"> Oclusi√≥n (Depth API)</label></div>
</div>

<button id="vrBtn">ENTRAR EN MR</button>

<script type="importmap">
{ "imports": {
  "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
  "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/",
  "stats": "https://cdn.jsdelivr.net/npm/stats.js@0.17.0/src/Stats.js"
} }
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { TransformControls } from 'three/addons/controls/TransformControls.js';
import Stats from 'stats';

const vShader = `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`;
const fShader = `
uniform sampler2D map; uniform bool chromaOn; uniform vec3 k1; uniform float sim1; uniform float uOpacity; 
varying vec2 vUv;
void main() {
  vec4 tex = texture2D(map, vUv);
  float alpha = tex.a;
  if(chromaOn) {
    float d = distance(tex.rgb, k1);
    alpha *= smoothstep(sim1, sim1 + 0.08, d);
  }
  gl_FragColor = vec4(tex.rgb, alpha * uOpacity);
  if(gl_FragColor.a < 0.01) discard;
}`;

let scene, camera, renderer, orbit, transformCtrl, xrSession, xrRefSpace;
let gridHelper, stats;
let objects = [], activeId = null;
let occlusionEnabled = false;

function init() {
  scene = new THREE.Scene();
  scene.add(new THREE.AmbientLight(0xffffff, 1.2));

  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 500);
  camera.position.set(2, 2, 4);

  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('c'), antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.xr.enabled = true;

  // --- NUEVA GRILLA ---
  gridHelper = new THREE.GridHelper(20, 20, 0x74b9ff, 0x2d3436);
  scene.add(gridHelper);

  // --- NUEVA GR√ÅFICA (STATS) ---
  stats = new Stats();
  stats.showPanel(0);
  stats.dom.style.position = 'absolute';
  stats.dom.style.top = 'auto';
  stats.dom.style.bottom = '20px';
  stats.dom.style.left = '20px';
  document.body.appendChild(stats.dom);

  orbit = new OrbitControls(camera, renderer.domElement);
  orbit.enableDamping = true;

  transformCtrl = new TransformControls(camera, renderer.domElement);
  transformCtrl.addEventListener('dragging-changed', e => orbit.enabled = !e.value);
  scene.add(transformCtrl);

  // Listeners de Sistema
  document.getElementById('checkGrid').onchange = (e) => gridHelper.visible = e.target.checked;
  document.getElementById('checkStats').onchange = (e) => stats.dom.style.display = e.target.checked ? 'block' : 'none';
  
  setupVR();
  renderer.setAnimationLoop(animate);
}

async function addAsset(url, type, name, isGif = false) {
  toggleLoader(true);
  let tex, video = null, gifData = null;
  try {
    if (isGif) {
      const resp = await fetch(url);
      const reader = new window.Omggif.GifReader(new Uint8Array(await resp.arrayBuffer()));
      const cvs = document.createElement('canvas');
      cvs.width = reader.width; cvs.height = reader.height;
      tex = new THREE.CanvasTexture(cvs);
      gifData = { reader, ctx: cvs.getContext('2d'), imgData: cvs.getContext('2d').createImageData(cvs.width, cvs.height), tex, frame: 0, nextTime: 0, playing: true };
    } else if (type === 'video') {
      video = document.createElement('video');
      video.src = url; video.loop = true; video.muted = true; video.playsInline = true; video.crossOrigin = "anonymous";
      await video.play();
      tex = new THREE.VideoTexture(video);
    } else {
      tex = await new THREE.TextureLoader().loadAsync(url);
    }
    tex.colorSpace = THREE.SRGBColorSpace;

    const mat = new THREE.ShaderMaterial({
      uniforms: { map: { value: tex }, chromaOn: { value: false }, k1: { value: new THREE.Color(0,1,0) }, sim1: { value: 0.4 }, uOpacity: { value: 1.0 } },
      vertexShader: vShader, fragmentShader: fShader, transparent: true, side: THREE.DoubleSide, depthWrite: false
    });

    const aspect = video ? video.videoWidth/video.videoHeight : (tex.image ? tex.image.width/tex.image.height : 1);
    const mesh = new THREE.Mesh(new THREE.PlaneGeometry(aspect * 2, 2), mat);
    mesh.position.set(0, 1.1, -1);
    
    const obj = { id: Math.random().toString(36).substr(2,9), name, mesh, video, gifData, type, billboard: false };
    objects.push(obj);
    scene.add(mesh);
    selectObject(obj.id);
  } catch (e) { alert("Error al cargar"); }
  toggleLoader(false);
}

function animate(time, frame) {
  stats.begin();
  orbit.update();
  
  objects.forEach(obj => {
    if(obj.billboard) obj.mesh.lookAt(camera.position.x, obj.mesh.position.y, camera.position.z);
    if (obj.gifData && obj.gifData.playing && performance.now() > obj.gifData.nextTime) {
      const g = obj.gifData;
      g.reader.decodeAndBlitFrameRGBA(g.frame, g.imgData.data);
      g.ctx.putImageData(g.imgData, 0, 0);
      g.tex.needsUpdate = true;
      g.nextTime = performance.now() + (g.reader.frameInfo(g.frame).delay * 10 || 100);
      g.frame = (g.frame + 1) % g.reader.numFrames();
    }
  });

  renderer.render(scene, camera);
  stats.end();
}

function selectObject(id) {
  activeId = id;
  const obj = objects.find(o => o.id === id);
  if (!obj) return;
  transformCtrl.attach(obj.mesh);
  document.getElementById('editorUI').style.display = 'block';
  updateLayers();
}

// Binders b√°sicos
const bind = (id, fn) => document.getElementById(id).addEventListener('input', e => { 
    const o = objects.find(o => o.id === activeId); 
    if(o) { fn(o, parseFloat(e.target.value)); document.getElementById('v_'+id).innerText = parseFloat(e.target.value).toFixed(2); }
});
bind('scale', (o,v) => o.mesh.scale.setScalar(v));
bind('opacity', (o,v) => o.mesh.material.uniforms.uOpacity.value = v);
bind('k1sim', (o,v) => o.mesh.material.uniforms.sim1.value = v);

document.getElementById('checkBillboard').onchange = (e) => {
    const o = objects.find(o => o.id === activeId);
    if(o) o.billboard = e.target.checked;
};

document.getElementById('chromaToggle').onchange = (e) => {
    const o = objects.find(o => o.id === activeId);
    if(o) {
        o.mesh.material.uniforms.chromaOn.value = e.target.checked;
        document.getElementById('chromaPanel').style.display = e.target.checked ? 'block' : 'none';
    }
};

window.loadFromWeb = () => {
  const url = document.getElementById('webUrl').value;
  if(url) addAsset(url, url.match(/\.(mp4|webm)/i) ? 'video' : 'image', "Web", url.includes('.gif'));
};

document.getElementById('fileInput').onchange = (e) => {
  for (let f of e.target.files) addAsset(URL.createObjectURL(f), f.type.includes('video') ? 'video' : 'image', f.name, f.name.includes('.gif'));
};

window.deleteActive = () => {
  const idx = objects.findIndex(o => o.id === activeId);
  if(idx > -1) { scene.remove(objects[idx].mesh); objects.splice(idx,1); transformCtrl.detach(); updateLayers(); }
};

window.centerActive = () => { const o = objects.find(o => o.id === activeId); if(o) o.mesh.position.set(0, 1.1, -1); };

function updateLayers() {
  const list = document.getElementById('layerList'); list.innerHTML = '';
  objects.forEach(o => {
    const d = document.createElement('div');
    d.className = `layer-item ${o.id === activeId ? 'active' : ''}`;
    d.innerHTML = `<span>${o.type === 'video' ? 'üé¨' : 'üñºÔ∏è'}</span> ${o.name.slice(0,15)}`;
    d.onclick = () => selectObject(o.id);
    list.appendChild(d);
  });
}

window.toggleUIPanel = () => {
    const ui = document.getElementById('ui');
    ui.classList.toggle('minimized');
    document.getElementById('toggleUI').style.display = ui.classList.contains('minimized') ? 'block' : 'none';
};

function setupVR() {
  if (navigator.xr) {
    navigator.xr.isSessionSupported('immersive-ar').then(ok => {
      if (ok) {
        const btn = document.getElementById('vrBtn');
        btn.style.display = 'block';
        btn.onclick = async () => {
          xrSession = await navigator.xr.requestSession('immersive-ar', {
             optionalFeatures: ['dom-overlay', 'depth-sensing'],
             domOverlay: { root: document.body }
          });
          renderer.xr.setSession(xrSession);
        };
      }
    });
  }
}

function toggleLoader(s) { document.getElementById('loader').style.display = s ? 'grid' : 'none'; }

init();
</script>
</body>
</html>
