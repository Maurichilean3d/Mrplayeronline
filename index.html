<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>MR Studio Diamond v26 | Full Persistence</title>
  
  <script src="https://unpkg.com/omggif@1.0.10/omggif.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    /* =========================================
       ESTILO "AMBER GLASS" (UI)
    ========================================= */
    :root {
        --main-color: #ffaa00; 
        --bg-glass: rgba(20, 20, 25, 0.92);
        --border-glass: rgba(255, 170, 0, 0.3);
        --text-glow: 0 0 8px rgba(255, 170, 0, 0.4);
    }

    * { box-sizing: border-box; user-select: none; font-family: 'Segoe UI', system-ui, sans-serif; }
    body { margin: 0; overflow: hidden; background: transparent; color: #eee; }
    #c { position: fixed; inset: 0; width: 100%; height: 100%; touch-action: none; z-index: 0; }
    
    .ui-panel { 
      position: fixed; left: 20px; top: 20px; width: 380px; max-height: 95vh; 
      background: var(--bg-glass);
      backdrop-filter: blur(30px) saturate(150%);
      -webkit-backdrop-filter: blur(30px) saturate(150%);
      border: 1px solid var(--border-glass); 
      border-radius: 24px; 
      padding: 20px; overflow-y: auto; z-index: 100; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      scrollbar-width: thin; scrollbar-color: var(--main-color) transparent;
      transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    .ui-panel.minimized { transform: translateX(-450px); }
    
    h2 { margin: 0 0 20px 0; font-size: 16px; color: var(--main-color); font-weight: 800; text-transform: uppercase; letter-spacing: 2px; border-bottom: 2px solid var(--border-glass); padding-bottom: 12px; display: flex; justify-content: space-between; text-shadow: var(--text-glow); }
    .sec-head { font-size: 11px; font-weight: 800; color: #aaa; margin: 20px 0 8px 0; text-transform: uppercase; letter-spacing: 1.5px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px; }
    
    .row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 12px; }
    label { flex: 1; color: #ddd; cursor: pointer; white-space: nowrap; font-weight: 500; }
    
    input[type=range] { flex: 2; height: 4px; accent-color: var(--main-color); background: rgba(255,255,255,0.1); border-radius: 2px; appearance: none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--main-color); border-radius: 50%; box-shadow: var(--text-glow); }
    input[type=checkbox] { width: 16px; height: 16px; accent-color: var(--main-color); cursor: pointer; }
    .val { width: 40px; text-align: right; font-size: 10px; color: var(--main-color); font-family: 'Fira Code', monospace; font-weight: bold; }
    
    select, input[type=url] { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border-glass); color: #fff; padding: 8px 12px; border-radius: 8px; outline: none; transition: 0.3s; }
    
    button { flex: 1; padding: 10px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; color: #000; background: var(--main-color); transition: 0.25s; font-size: 11px; text-transform: uppercase; box-shadow: var(--text-glow); }
    button:active { transform: scale(0.97); }
    button.danger { background: #ff3333; color: white; box-shadow: 0 0 8px rgba(255, 51, 51, 0.6); }
    button.drive { background: #00C853; color: white; box-shadow: 0 0 8px rgba(0, 200, 83, 0.6); }
    button.secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid var(--border-glass); box-shadow: none; }

    #toggleUI { position: fixed; left: 20px; top: 20px; z-index: 101; width: 44px; height: 44px; border-radius: 50%; background: var(--bg-glass); backdrop-filter: blur(20px); border: 2px solid var(--main-color); color: var(--main-color); font-weight:bold; cursor: pointer; display: none; box-shadow: var(--text-glow); font-size: 20px; align-items: center; justify-content: center; }
    #vrBtn { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); padding: 16px 50px; background: var(--main-color); color: #000; border-radius: 50px; font-weight: 900; z-index: 1000; display: none; box-shadow: 0 0 30px rgba(255, 170, 0, 0.7); border: 3px solid #fff; font-size: 14px; letter-spacing: 2px; }
    .loader { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; place-items: center; color: var(--main-color); font-weight: 900; letter-spacing: 4px; font-size: 24px; text-shadow: var(--text-glow); }
    
    .color-btn { width: 26px; height: 26px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(255,255,255,0.2); transition: 0.2s; }
    .color-btn:hover { transform: scale(1.15); border-color: #fff; box-shadow: 0 0 15px currentColor; }
    #currentColorBox { width: 100%; height: 12px; border-radius: 6px; background: #0f0; margin-bottom: 12px; border: 2px solid rgba(255,255,255,0.3); }
    .layer-list { max-height: 120px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 8px; margin-bottom: 15px; border: 1px solid var(--border-glass); }
    .layer-item { padding: 8px 10px; font-size: 11px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-bottom: 4px; transition: 0.2s; font-weight: 600; }
    .layer-item.active { background: rgba(255, 170, 0, 0.2); border-left: 3px solid var(--main-color); color: #fff; }
  </style>
</head>
<body>

<canvas id="c"></canvas>
<div class="loader" id="loader">CARGANDO DIAMOND v26...</div>
<button id="toggleUI" onclick="document.getElementById('ui').classList.toggle('minimized')">‚ò∞</button>

<div class="ui-panel" id="ui">
  <h2>DIAMOND v26 <span onclick="document.getElementById('ui').classList.toggle('minimized')" style="cursor:pointer;">√ó</span></h2>

  <div class="sec-head">üìê Arquitectura</div>
  <div class="row">
      <select id="unitSystem" onchange="updateUnits()">
          <option value="m">Metros (m)</option>
          <option value="cm">Cent√≠metros (cm)</option>
          <option value="ft">Pies (ft)</option>
      </select>
  </div>
  <div class="row"><label><input type="checkbox" id="showDims" checked> Cotas Din√°micas</label></div>
  <div class="row"><label><input type="checkbox" id="showCoords" checked> Coordenadas X/Y/Z</label></div>
  <div class="row"><label><input type="checkbox" id="showGrid" checked onchange="updateGrid()"> Suelo Hologr√°fico</label></div>

  <div class="sec-head">üíæ Proyecto & Nube</div>
  <div class="row" style="gap:5px;">
      <button onclick="saveLocal()" class="secondary" title="Descargar JSON a tu PC">üíæ LOCAL</button>
      <button onclick="document.getElementById('jsonInput').click()" class="secondary" title="Cargar JSON desde PC">üìÇ ABRIR</button>
      <input type="file" id="jsonInput" accept=".json" style="display:none" onchange="loadLocal(this)">
  </div>
  <div class="row" id="authPanel" style="margin-top:5px;">
      <button onclick="handleAuthClick()" class="drive">‚òÅÔ∏è CONECTAR DRIVE</button>
  </div>
  <div class="row" id="driveActions" style="display:none; gap:5px; margin-top:5px;">
      <button onclick="saveSceneToDrive()" class="drive">‚òÅÔ∏è GUARDAR</button>
      <button onclick="loadSceneFromDrive()" class="drive">‚òÅÔ∏è CARGAR</button>
  </div>

  <div class="sec-head">üì• Importar (Img/Video/GIF)</div>
  <div class="row">
    <input type="url" id="webUrl" placeholder="URL Video/Imagen/GIF">
    <button onclick="loadFromWeb()" style="flex:0 0 40px;">+</button>
  </div>
  <button onclick="document.getElementById('fileInput').click()" class="secondary" style="margin-top:8px; width:100%;">üìÅ ABRIR MEDIA LOCAL</button>
  <input type="file" id="fileInput" multiple style="display:none;">
  
  <div class="sec-head">Capas Activas</div>
  <div id="layerList" class="layer-list"></div>

  <div id="editorUI" style="display:none;">
    
    <div class="sec-head">üåê Proyecci√≥n & Transform</div>
    <div class="row">
        <select id="projSelect" onchange="updateProjection()">
          <option value="plane">Plano 2D (Standard)</option>
          <option value="curved">Pantalla Curva</option>
          <option value="orb">Orbe Flotante</option>
          <option value="360">Entorno 360¬∞ (Video Sphere)</option>
        </select>
    </div>
    
    <div class="row" style="background:rgba(255,255,255,0.05); padding:5px; border-radius:5px;">
        <label><input type="checkbox" id="checkBillboard"> Billboard (Mirar a C√°mara)</label>
    </div>

    <div class="row"><label>Pos X</label><input type="range" id="posX" min="-5" max="5" step="0.1"><span class="val" id="v_posX">0</span></div>
    <div class="row"><label>Pos Y</label><input type="range" id="posY" min="0" max="5" step="0.1"><span class="val" id="v_posY">1.6</span></div>
    <div class="row"><label>Pos Z</label><input type="range" id="posZ" min="-10" max="10" step="0.1"><span class="val" id="v_posZ">-2</span></div>
    <div class="row"><label>Escala</label><input type="range" id="scale" min="0.1" max="5" step="0.1"><span class="val" id="v_scale">1</span></div>
    <div class="row"><label>Rot Y</label><input type="range" id="rotY" min="0" max="6.28" step="0.1"><span class="val" id="v_rotY">0</span></div>

    <div class="sec-head">üé® Imagen & Chroma</div>
    <div class="row"><label>Opacidad</label><input type="range" id="opacity" min="0" max="1" step="0.01" value="1"><span class="val" id="v_opacity">1</span></div>
    <div class="row"><label>Brillo</label><input type="range" id="brightness" min="-1" max="1" step="0.05" value="0"><span class="val" id="v_brightness">0</span></div>
    <div class="row"><label>Saturaci√≥n</label><input type="range" id="saturation" min="0" max="3" step="0.1" value="1"><span class="val" id="v_saturation">1</span></div>

    <div class="row"><label><input type="checkbox" id="chromaToggle"> Activar Chroma</label> <label><input type="checkbox" id="chromaInvert"> Invertir</label></div>
    <div id="chromaPanel" style="display:none; padding:12px; background:rgba(0,0,0,0.2); border-radius:12px; border:1px solid var(--border-glass);">
        <div id="currentColorBox"></div>
        <div class="row" style="justify-content: space-around; margin-bottom:15px;">
            <div class="color-btn" style="background:#00ff00;" onclick="setChromaPreset(0,1,0)" title="Verde"></div>
            <div class="color-btn" style="background:#0000ff;" onclick="setChromaPreset(0,0,1)" title="Azul"></div>
            <div class="color-btn" style="background:#000000;" onclick="setChromaPreset(0,0,0)" title="Negro"></div>
        </div>
        <div class="row"><label>Rango</label><input type="range" id="k1sim" min="0" max="0.8" step="0.001"><span class="val" id="v_k1sim">0.4</span></div>
        <div class="row"><label>Suave</label><input type="range" id="k1smooth" min="0" max="0.4" step="0.001"><span class="val" id="v_k1smooth">0.08</span></div>
        <div class="row"><label>Despill</label><input type="range" id="despill" min="0" max="1" step="0.01"><span class="val" id="v_despill">0.5</span></div>
        
        <input type="hidden" id="keyR" value="0"><input type="hidden" id="keyG" value="1"><input type="hidden" id="keyB" value="0">
    </div>
    
    <div class="row" style="margin-top:20px; gap:8px;">
        <button onclick="mediaAction('play')" class="secondary">‚ñ∂ REPRODUCIR</button>
        <button onclick="mediaAction('pause')" class="secondary">‚è∏ PAUSAR</button>
    </div>
    <button class="danger" onclick="deleteActive()" style="width:100%; margin-top:5px;">üóëÔ∏è ELIMINAR CAPA</button>
  </div>

  <div class="sec-head">‚öôÔ∏è Realidad Mixta</div>
  <div class="row"><label><input type="checkbox" id="checkOcclusion"> Oclusi√≥n (Depth API)</label></div>
</div>

<button id="vrBtn">INICIAR HYBRID MR</button>

<script type="importmap">
{ "imports": {
  "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
  "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
} }
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { TransformControls } from 'three/addons/controls/TransformControls.js';
import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';

// ==========================================
// ‚òÅÔ∏è CONFIGURACI√ìN GOOGLE DRIVE
// ==========================================
// Pega aqu√≠ tus credenciales de Google Cloud Console si vas a usar Drive
const CLIENT_ID = ''; 
const API_KEY = ''; 
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

// ==========================================
// üåë SHADERS (INTACTOS)
// ==========================================
const depthVS = `#version 300 es
in vec2 aPos; out vec2 vUv; void main(){ vUv = aPos * 0.5 + 0.5; gl_Position = vec4(aPos, 0.0, 1.0); }`;
const depthFS = `#version 300 es
precision highp float; precision highp sampler2D; in vec2 vUv; uniform sampler2D uDepth; uniform float uRawToMeters; uniform mat4 uProj; out vec4 outColor;
float decode(vec4 la){ return (la.r * 255.0 * 256.0 + la.a * 255.0); }
void main(){ 
  float zMeters = decode(texture(uDepth, vUv)) * uRawToMeters; if(zMeters <= 0.0) discard;
  float z = -zMeters; float clipZ = uProj[2][2] * z + uProj[3][2]; float clipW = uProj[2][3] * z + uProj[3][3];
  gl_FragDepth = clamp((clipZ / clipW) * 0.5 + 0.5, 0.0, 1.0); outColor = vec4(0.0); 
}`;

const vShader = `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`;
const fShader = `
uniform sampler2D map; 
uniform float uBrightness, uContrast, uSaturation, uOpacity;
uniform bool chromaOn, chromaInvert; 
uniform vec3 k1; 
uniform float sim1, smooth1, despill;
varying vec2 vUv;

vec3 rgb2hsv(vec3 c) {
    vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));
    float d = q.x - min(q.w, q.y);
    float e = 1.0e-10;
    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
}

void main() {
  vec4 tex = texture2D(map, vUv);
  vec3 col = tex.rgb;
  float alpha = tex.a * uOpacity;

  if(chromaOn) {
      vec3 hsv = rgb2hsv(col); vec3 kHsv = rgb2hsv(k1);
      float hueDist = abs(hsv.x - kHsv.x); if (hueDist > 0.5) hueDist = 1.0 - hueDist;
      float dist = sqrt(pow(hueDist * 2.0, 2.0) + pow(abs(hsv.y - kHsv.y), 2.0) + pow(abs(hsv.z - kHsv.z) * 0.5, 2.0));
      float mask = smoothstep(sim1, sim1 + smooth1, dist);
      
      if(!chromaInvert) {
          alpha *= mask;
          if(mask < 0.95 && despill > 0.0) {
             if(k1.g > k1.r && k1.g > k1.b) col.g = mix(col.g, max(col.r, col.b), (1.0 - mask) * despill);
             else if(k1.b > k1.r && k1.b > k1.g) col.b = mix(col.b, max(col.r, col.g), (1.0 - mask) * despill);
          }
      } else { alpha = (1.0 - mask) * uOpacity; col = vec3(1.0); }
  }

  col += uBrightness; col = (col - 0.5) * uContrast + 0.5;
  float gray = dot(col, vec3(0.299, 0.587, 0.114)); col = mix(vec3(gray), col, uSaturation);
  
  gl_FragColor = vec4(col, alpha); if(alpha < 0.01) discard; 
}`;

// ==========================================
// ‚öôÔ∏è VARIABLES GLOBALES
// ==========================================
let scene, camera, renderer, orbit, transformCtrl, xrSession, xrRefSpace;
let objects = [], activeId = null, clock = new THREE.Clock();
let xrGlBinding = null, depthProgram = null, depthVao = null, depthTex = null, occlusionEnabled = false;
let controller1, controller2, controllerGrip1, controllerGrip2, raycaster, tempMatrix = new THREE.Matrix4();
let engGroup, coordLabels = { x:null, y:null, z:null }, dimLabels = { w:null, h:null, d:null };
let currentUnit = 'm';

/* ‚úÖ FIX MINIMO (Quest): throttle de UI para no reventar el DOM-overlay en XR */
let lastUIUpdate = 0;

function init() {
  scene = new THREE.Scene(); scene.add(new THREE.AmbientLight(0xffedd5, 1.2));
  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 500); camera.position.set(0, 1.6, 2);
  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('c'), antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(window.devicePixelRatio); 
  renderer.xr.enabled = true; renderer.outputColorSpace = THREE.SRGBColorSpace;

  orbit = new OrbitControls(camera, renderer.domElement);
  transformCtrl = new TransformControls(camera, renderer.domElement);
  transformCtrl.addEventListener('dragging-changed', e => orbit.enabled = !e.value);
  transformCtrl.addEventListener('change', updateUIFromGizmo);
  scene.add(transformCtrl);
  
  initEngineeringUI(); updateGrid(); setupXRControllers(); setupVR();
  renderer.setAnimationLoop(animate);
  
  // Event Listeners UI
  document.getElementById('chromaToggle').addEventListener('change', updateMaterial);
  document.getElementById('chromaInvert').addEventListener('change', updateMaterial);
  document.querySelectorAll('input[type=range]').forEach(i => {
      if(!['keyR','keyG','keyB','posX','posY','posZ','scale','rotY'].includes(i.id)) {
        i.addEventListener('input', e => {
            const val = parseFloat(e.target.value);
            const lbl = document.getElementById('v_' + e.target.id);
            if(lbl) lbl.innerText = val.toFixed(3);
            updateMaterialParam(e.target.id, val);
        });
      }
  });

  const bindT = (id, fn) => {
    document.getElementById(id).addEventListener('input', (e) => {
        const obj = objects.find(o => o.id === activeId);
        if(obj) {
            const v = parseFloat(e.target.value);
            fn(obj, v);
            document.getElementById('v_' + id).innerText = v.toFixed(2);
            updateEngineeringVisuals();
        }
    });
  };
  bindT('posX', (o,v) => o.mesh.position.x = v);
  bindT('posY', (o,v) => o.mesh.position.y = v);
  bindT('posZ', (o,v) => o.mesh.position.z = v);
  bindT('scale', (o,v) => o.mesh.scale.setScalar(v));
  bindT('rotY', (o,v) => o.mesh.rotation.y = v);

  document.getElementById('checkBillboard').onchange = (e) => {
      const obj = objects.find(o => o.id === activeId);
      if(obj) {
          obj.billboard = e.target.checked;
          if(!obj.billboard) { 
            obj.mesh.rotation.set(0,0,0);
            document.getElementById('rotY').value = 0;
            document.getElementById('v_rotY').innerText = "0";
          }
      }
  };

  window.updateUnits = () => { currentUnit = document.getElementById('unitSystem').value; updateGrid(); };
  window.updateGrid = updateGrid;
  window.setChromaPreset = (r,g,b) => { 
      document.getElementById('keyR').value=r; document.getElementById('keyG').value=g; document.getElementById('keyB').value=b; 
      updateChromaManual(); 
  };
}

/* ... TODO EL RESTO DE TU C√ìDIGO VA IGUAL HASTA handleStableControls() ... */
function handleStableControls() {
    const s = renderer.xr.getSession(); if (!s || !activeId) return;
    const obj = objects.find(o => o.id === activeId); if (!obj || !obj.mesh) return;

    const now = performance.now();
    let changed = false;

    for (const src of s.inputSources) {
        const gp = src.gamepad; if (!gp) continue;
        const grip = gp.buttons?.[1]?.pressed === true;
        const axes = gp.axes || [];

        let ax = (axes.length >= 4) ? axes[2] : (axes[0] ?? 0);
        let ay = (axes.length >= 4) ? axes[3] : (axes[1] ?? 0);
        if (!Number.isFinite(ax)) ax = 0;
        if (!Number.isFinite(ay)) ay = 0;

        /* ‚úÖ Deadzone un poco m√°s firme para evitar drift */
        if (Math.abs(ax) < 0.18) ax = 0;
        if (Math.abs(ay) < 0.18) ay = 0;

        if (src.handedness === 'left' && grip) {
            if (ay !== 0) {
                obj.mesh.position.y -= ay * 0.02;
                if (obj.mesh.position.y < 0) obj.mesh.position.y = 0;
                changed = true;
            }

            if (ax !== 0) {
                /* ‚úÖ FIX: escalado LINEAL (no exponencial) + clamp seguro
                   Esto evita que el objeto explote en tama√±o en pocos segundos (Quest se cuelga f√°cil). */
                const MIN_S = 0.05;
                const MAX_S = 10.0;   /* m√°s seguro para Quest */
                const STEP = 0.03;    /* velocidad de escala */

                let s0 = obj.mesh.scale.x;
                s0 += ax * STEP;
                if (s0 < MIN_S) s0 = MIN_S;
                if (s0 > MAX_S) s0 = MAX_S;
                obj.mesh.scale.setScalar(s0);

                changed = true;
            }

            /* ‚úÖ FIX: throttle UI update (dom-overlay en Quest se muere si escribes DOM cada frame) */
            if (changed && (now - lastUIUpdate) > 100) { /* ~10 Hz */
                updateUIFromGizmo();
                lastUIUpdate = now;
            } else if (changed) {
                /* si hay cambios, igual mantenemos valores internos sin reventar UI */
            }
        }

        if (src.handedness === 'right' && grip) {
            if (ay !== 0) {
                const dir = new THREE.Vector3().subVectors(obj.mesh.position, camera.position).normalize();
                dir.y = 0;
                obj.mesh.position.addScaledVector(dir, ay * -0.05);
                changed = true;
            }
            if (ax !== 0) {
                obj.mesh.rotation.y -= ax * 0.05;
                changed = true;
            }

            if (changed && (now - lastUIUpdate) > 100) {
                updateUIFromGizmo();
                lastUIUpdate = now;
            }
        }
    }
}

function onGripStart(e) { 
    const c = e.target; const hits = getIntersections(c); 
    if(hits.length > 0) { const o = hits[0].object; if(o.userData.id) selectObject(o.userData.id); c.attach(o); c.userData.selected = o; } 
}
function onGripEnd(e) { const c = e.target; if(c.userData.selected) { scene.attach(c.userData.selected); c.userData.selected = null; } }
function onSelect(e) { const hits = getIntersections(e.target); if(hits.length>0 && hits[0].object.userData.id) selectObject(hits[0].object.userData.id); }
function getIntersections(c) { 
    tempMatrix.identity().extractRotation(c.matrixWorld); raycaster.ray.origin.setFromMatrixPosition(c.matrixWorld); raycaster.ray.direction.set(0,0,-1).applyMatrix4(tempMatrix); 
    return raycaster.intersectObjects(objects.map(o=>o.mesh), false); 
}

/* ======== RESTO DE TU ARCHIVO SIN CAMBIOS ======== */

async function addAsset(url, type, name, isGif=false, isRestore=false) {
  if(!isRestore) document.getElementById('loader').style.display='grid';
  let tex, mesh, gifData=null, video=null, newObj=null;
  try {
    if(isGif) {
        const resp = await fetch(url);
        const buf = await resp.arrayBuffer();
        const r = new window.Omggif.GifReader(new Uint8Array(buf));
        const cvs = document.createElement('canvas'); cvs.width=r.width; cvs.height=r.height;
        const ctx = cvs.getContext('2d'); const dat=ctx.createImageData(r.width,r.height);
        tex = new THREE.CanvasTexture(cvs); tex.colorSpace=THREE.SRGBColorSpace;
        gifData={r, ctx, dat, tex, f:0, nextTime:0, playing:true};
    } 
    else if(type==='video') {
        video=document.createElement('video'); video.src=url; video.crossOrigin='anonymous'; video.loop=true; video.muted=true; video.playsInline=true;
        await video.play(); tex=new THREE.VideoTexture(video); tex.colorSpace=THREE.SRGBColorSpace;
    } 
    else {
        tex=await new THREE.TextureLoader().loadAsync(url); tex.colorSpace=THREE.SRGBColorSpace;
    }

    const ar = video ? video.videoWidth/video.videoHeight : (tex.image?tex.image.width/tex.image.height:1.77);
    const mat = new THREE.ShaderMaterial({
        uniforms: { 
            map:{value:tex}, uBrightness:{value:0}, uContrast:{value:1}, uSaturation:{value:1}, uOpacity:{value:1},
            chromaOn:{value:false}, chromaInvert:{value:false}, k1:{value:new THREE.Color(0,1,0)}, sim1:{value:0.4}, smooth1:{value:0.08}, despill:{value:0.5} 
        },
        vertexShader: vShader, fragmentShader: fShader, transparent:true, side:THREE.DoubleSide, depthWrite:false
    });
    
    mesh = new THREE.Mesh(new THREE.PlaneGeometry(ar, 1), mat);
    mesh.position.set(0, 1.6, -2);
    mesh.userData.id = Math.random().toString(36).substr(2,9);
    
    newObj = { 
        id:mesh.userData.id, name, mesh, video, gifData, type, 
        billboard:false, originalAspect:ar, sourceUrl:url, projectionMode:'plane'
    };
    
    objects.push(newObj); scene.add(mesh);
    if(!isRestore) selectObject(newObj.id);
  } catch(e){ console.error(e); if(!isRestore) alert("Error cargando Asset"); }
  if(!isRestore) document.getElementById('loader').style.display='none';
  return newObj;
}

/* ... (resto EXACTO de tu c√≥digo tal como lo enviaste) ... */

init();
</script>
</body>
</html>

