<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>MR Studio Diamond</title>

  <script src="https://unpkg.com/omggif@1.0.10/omggif.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* =========================================
       iOS / iPadOS DESIGN SYSTEM
       Ultra minimal, t√°ctil, directo
    ========================================= */
    :root {
      /* Colors iOS-style */
      --ios-blue: #007AFF;
      --ios-yellow: #FFD60A;
      --ios-red: #FF453A;
      --ios-green: #32D74B;
      --ios-orange: #FF9F0A;
      
      /* Grises iOS */
      --gray-1: #1C1C1E;
      --gray-2: #2C2C2E;
      --gray-3: #3A3A3C;
      --gray-4: #48484A;
      --gray-5: #636366;
      --gray-6: #8E8E93;
      
      --bg-primary: #F2F2F7;
      --bg-secondary: #FFFFFF;
      --bg-tertiary: rgba(255, 255, 255, 0.95);
      
      /* Sombras suaves iOS */
      --shadow-1: 0 1px 4px rgba(0, 0, 0, 0.04);
      --shadow-2: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-3: 0 8px 24px rgba(0, 0, 0, 0.12);
      
      /* Radios iOS */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      
      /* Espaciado */
      --s-1: 4px;
      --s-2: 8px;
      --s-3: 12px;
      --s-4: 16px;
      --s-5: 20px;
      --s-6: 24px;
      --s-8: 32px;
    }

    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', system-ui, sans-serif;
      overflow: hidden; 
      background: var(--bg-primary);
      color: var(--gray-1);
      user-select: none;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Canvas */
    #c { 
      position: fixed; 
      inset: 0; 
      width: 100%; 
      height: 100%; 
      touch-action: none; 
      z-index: 0; 
    }

    #css3d {
      position: fixed; 
      inset: 0; 
      width: 100%; 
      height: 100%;
      pointer-events: none; 
      z-index: 1;
    }
    #css3d.interactive { pointer-events: auto; }

    /* =========================================
       TOOLBAR - Estilo iPad
    ========================================= */
    .toolbar {
      position: fixed;
      top: var(--s-4);
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: var(--s-2);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      padding: var(--s-2);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-3);
      z-index: 200;
    }

    .tool-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--gray-1);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tool-btn:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .tool-btn:active {
      background: rgba(0, 0, 0, 0.1);
      transform: scale(0.95);
    }

    .tool-btn.active {
      background: var(--ios-blue);
      color: white;
    }

    /* =========================================
       PANEL FLOTANTE - Estilo Perspective Settings
    ========================================= */
    .floating-panel {
      position: fixed;
      top: 80px;
      right: var(--s-4);
      width: 280px;
      background: rgba(28, 28, 30, 0.95);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      border-radius: var(--radius-xl);
      padding: var(--s-4);
      box-shadow: var(--shadow-3);
      z-index: 150;
      color: white;
      display: none;
      animation: slideIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .floating-panel.active {
      display: block;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .panel-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: var(--s-4);
      text-align: center;
      letter-spacing: -0.2px;
    }

    .panel-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--s-3) 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .panel-row:last-child {
      border-bottom: none;
    }

    .panel-label {
      display: flex;
      align-items: center;
      gap: var(--s-2);
      font-size: 14px;
      font-weight: 400;
    }

    .panel-label-icon {
      font-size: 18px;
    }

    /* =========================================
       TOGGLE SWITCH - Estilo iOS
    ========================================= */
    .toggle-switch {
      position: relative;
      width: 51px;
      height: 31px;
      cursor: pointer;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 31px;
      transition: 0.3s;
    }

    .toggle-slider::before {
      content: '';
      position: absolute;
      height: 27px;
      width: 27px;
      left: 2px;
      bottom: 2px;
      background: white;
      border-radius: 50%;
      transition: 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch input:checked + .toggle-slider {
      background: var(--ios-yellow);
    }

    .toggle-switch input:checked + .toggle-slider::before {
      transform: translateX(20px);
    }

    /* =========================================
       LAYERS PANEL - Minimalista
    ========================================= */
    .layers-panel {
      position: fixed;
      left: var(--s-4);
      top: 80px;
      width: 320px;
      max-height: calc(100vh - 100px);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-3);
      z-index: 150;
      display: none;
      overflow: hidden;
    }

    .layers-panel.active {
      display: flex;
      flex-direction: column;
    }

    .layers-header {
      padding: var(--s-4);
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .layers-title {
      font-size: 17px;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .layers-actions {
      display: flex;
      gap: var(--s-2);
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      border: none;
      background: transparent;
      color: var(--gray-1);
      font-size: 16px;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-btn:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .icon-btn:active {
      background: rgba(0, 0, 0, 0.1);
      transform: scale(0.95);
    }

    .layers-list {
      flex: 1;
      overflow-y: auto;
      padding: var(--s-2);
    }

    .layer-item {
      display: flex;
      align-items: center;
      gap: var(--s-3);
      padding: var(--s-3);
      border-radius: var(--radius-md);
      margin-bottom: var(--s-1);
      cursor: pointer;
      transition: all 0.15s;
      background: white;
    }

    .layer-item:hover {
      background: rgba(0, 122, 255, 0.05);
    }

    .layer-item.active {
      background: var(--ios-blue);
      color: white;
    }

    .layer-icon {
      font-size: 20px;
      width: 24px;
      text-align: center;
    }

    .layer-name {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
      letter-spacing: -0.2px;
    }

    .layer-tag {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(0, 0, 0, 0.08);
      letter-spacing: 0.3px;
    }

    .layer-item.active .layer-tag {
      background: rgba(255, 255, 255, 0.2);
    }

    .layer-vis {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: none;
      background: transparent;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .layer-vis:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    /* =========================================
       CONTROLS PANEL - Transform
    ========================================= */
    .controls-panel {
      position: fixed;
      bottom: var(--s-4);
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 600px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      border-radius: var(--radius-xl);
      padding: var(--s-4);
      box-shadow: var(--shadow-3);
      z-index: 150;
      display: none;
    }

    .controls-panel.active {
      display: block;
    }

    .control-group {
      margin-bottom: var(--s-4);
    }

    .control-group:last-child {
      margin-bottom: 0;
    }

    .control-group-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--gray-5);
      margin-bottom: var(--s-2);
      letter-spacing: 0.5px;
    }

    .control-item {
      display: flex;
      align-items: center;
      gap: var(--s-3);
      margin-bottom: var(--s-2);
    }

    .control-label {
      width: 20px;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-3);
    }

    .control-slider {
      flex: 1;
      height: 4px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 2px;
      outline: none;
      appearance: none;
      cursor: pointer;
    }

    .control-slider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      background: white;
      border: 2px solid var(--ios-blue);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .control-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: white;
      border: 2px solid var(--ios-blue);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .control-value {
      width: 50px;
      text-align: right;
      font-size: 13px;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
      color: var(--gray-3);
    }

    /* =========================================
       XR BUTTON
    ========================================= */
    #vrBtn {
      position: fixed;
      bottom: var(--s-4);
      right: var(--s-4);
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--ios-blue);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: var(--shadow-3);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    #vrBtn:hover {
      transform: scale(1.05);
    }

    #vrBtn:active {
      transform: scale(0.95);
    }

    /* =========================================
       LOADER
    ========================================= */
    .loader {
      position: fixed;
      inset: 0;
      background: var(--bg-primary);
      z-index: 5000;
      display: none;
      place-items: center;
      flex-direction: column;
      gap: var(--s-6);
    }

    .loader-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-top: 3px solid var(--ios-blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* =========================================
       RESPONSIVE
    ========================================= */
    @media (max-width: 768px) {
      .layers-panel,
      .floating-panel {
        width: calc(100vw - 32px);
        left: var(--s-4);
        right: var(--s-4);
      }
      
      .toolbar {
        width: calc(100vw - 32px);
      }
    }

    /* =========================================
       SCROLLBARS - iOS style
    ========================================= */
    ::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 2px;
    }
  </style>
</head>
<body>

  <canvas id="c"></canvas>
  <div id="css3d"></div>

  <div class="loader" id="loader">
    <div class="loader-spinner"></div>
  </div>

  <!-- TOOLBAR -->
  <div class="toolbar">
    <button class="tool-btn" onclick="togglePanel('layers')" title="Capas">üìö</button>
    <button class="tool-btn" onclick="togglePanel('settings')" title="Configuraci√≥n">‚öôÔ∏è</button>
    <button class="tool-btn" onclick="addImageLayer()" title="Imagen">üñºÔ∏è</button>
    <button class="tool-btn" onclick="addVideoLayer()" title="Video">üé¨</button>
    <button class="tool-btn" onclick="startNewMeasure()" title="Medir">üìè</button>
    <button class="tool-btn" onclick="createCalibrator()" title="Calibrador">üìê</button>
    <button class="tool-btn danger" onclick="clearAllMeasures()" title="Limpiar">üóëÔ∏è</button>
  </div>

  <!-- SETTINGS PANEL -->
  <div class="floating-panel" id="settingsPanel">
    <div class="panel-title">Perspective Settings</div>
    
    <div class="panel-row">
      <div class="panel-label">
        <span class="panel-label-icon">üîí</span>
        Lock
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="lockToggle">
        <span class="toggle-slider"></span>
      </label>
    </div>

    <div class="panel-row">
      <div class="panel-label">
        <span class="panel-label-icon">üî≥</span>
        Grid
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="gridToggle" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>

    <div class="panel-row">
      <div class="panel-label">
        <span class="panel-label-icon">üß≠</span>
        Guide
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="guideToggle" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>

    <div class="panel-row">
      <div class="panel-label">
        <span class="panel-label-icon">ü§ù</span>
        Assist
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="assistToggle">
        <span class="toggle-slider"></span>
      </label>
    </div>

    <div class="panel-row">
      <div class="panel-label">
        <span class="panel-label-icon">üëÅÔ∏è</span>
        Occlusion
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="checkOcclusion">
        <span class="toggle-slider"></span>
      </label>
    </div>

    <div class="panel-row">
      <div class="panel-label">
        <span class="panel-label-icon">üìê</span>
        Imperial
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="sysImperial" onchange="updateUnitOptions()">
        <span class="toggle-slider"></span>
      </label>
    </div>
  </div>

  <!-- LAYERS PANEL -->
  <div class="layers-panel" id="layersPanel">
    <div class="layers-header">
      <div class="layers-title">Capas</div>
      <div class="layers-actions">
        <button class="icon-btn" onclick="newDrawLayer()" title="Nueva capa">‚ûï</button>
        <button class="icon-btn" onclick="deleteSelectedDrawLayer()" title="Eliminar">üóëÔ∏è</button>
      </div>
    </div>
    <div class="layers-list" id="layersList"></div>
  </div>

  <!-- CONTROLS PANEL -->
  <div class="controls-panel" id="controlsPanel">
    <div class="control-group">
      <div class="control-group-title">Posici√≥n</div>
      <div class="control-item">
        <div class="control-label">X</div>
        <input type="range" class="control-slider" id="posX" min="-10" max="10" step="0.01" value="0" oninput="onPosX(+this.value)">
        <div class="control-value" id="v_posX">0.00</div>
      </div>
      <div class="control-item">
        <div class="control-label">Y</div>
        <input type="range" class="control-slider" id="posY" min="-10" max="10" step="0.01" value="0" oninput="onPosY(+this.value)">
        <div class="control-value" id="v_posY">0.00</div>
      </div>
      <div class="control-item">
        <div class="control-label">Z</div>
        <input type="range" class="control-slider" id="posZ" min="-10" max="10" step="0.01" value="0" oninput="onPosZ(+this.value)">
        <div class="control-value" id="v_posZ">0.00</div>
      </div>
    </div>

    <div class="control-group">
      <div class="control-group-title">Escala</div>
      <div class="control-item">
        <div class="control-label">X</div>
        <input type="range" class="control-slider" id="scX" min="0.1" max="5" step="0.01" value="1" oninput="onScX(+this.value)">
        <div class="control-value" id="v_scX">1.00</div>
      </div>
      <div class="control-item">
        <div class="control-label">Y</div>
        <input type="range" class="control-slider" id="scY" min="0.1" max="5" step="0.01" value="1" oninput="onScY(+this.value)">
        <div class="control-value" id="v_scY">1.00</div>
      </div>
    </div>

    <div class="control-group">
      <div class="control-group-title">Rotaci√≥n</div>
      <div class="control-item">
        <div class="control-label">X</div>
        <input type="range" class="control-slider" id="rotX" min="-3.14159" max="3.14159" step="0.01" value="0" oninput="onRotX(+this.value)">
        <div class="control-value" id="v_rotX">0.00</div>
      </div>
      <div class="control-item">
        <div class="control-label">Y</div>
        <input type="range" class="control-slider" id="rotY" min="-3.14159" max="3.14159" step="0.01" value="0" oninput="onRotY(+this.value)">
        <div class="control-value" id="v_rotY">0.00</div>
      </div>
      <div class="control-item">
        <div class="control-label">Z</div>
        <input type="range" class="control-slider" id="rotZ" min="-3.14159" max="3.14159" step="0.01" value="0" oninput="onRotZ(+this.value)">
        <div class="control-value" id="v_rotZ">0.00</div>
      </div>
    </div>
  </div>

  <button id="vrBtn">ü•Ω</button>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/controls/OrbitControls.js';
    import { TransformControls } from 'https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/controls/TransformControls.js';
    import { CSS3DRenderer, CSS3DObject } from 'https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/renderers/CSS3DRenderer.js';
    import { GLTFExporter } from 'https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/exporters/GLTFExporter.js';

    let camera, scene, renderer, cssRenderer;
    let orbit, transformCtrl;
    let objects = [];
    let activeId = null;
    let isLive = false;

    let drawLayers = [];
    let selectedDrawLayerIndex = -1;
    let measureMode = false;
    let measurePoints = [];
    let measureLines = [];

    let xrRefSpace = null;
    let xrGlBinding = null;
    let depthTex;
    let grid;

    function init() {
      const canvas = document.getElementById('c');
      const css3dEl = document.getElementById('css3d');

      scene = new THREE.Scene();
      scene.background = null;

      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.01, 100);
      camera.position.set(0, 1.6, 3);

      renderer = new THREE.WebGLRenderer({ 
        canvas, 
        antialias: true, 
        alpha: true 
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.xr.enabled = true;

      cssRenderer = new CSS3DRenderer({ element: css3dEl });
      cssRenderer.setSize(window.innerWidth, window.innerHeight);

      orbit = new OrbitControls(camera, renderer.domElement);
      orbit.enableDamping = true;
      orbit.dampingFactor = 0.05;

      transformCtrl = new TransformControls(camera, renderer.domElement);
      transformCtrl.addEventListener('dragging-changed', (e) => {
        orbit.enabled = !e.value;
      });
      transformCtrl.addEventListener('change', () => {
        if (!isLive) syncTransformToUI();
      });
      scene.add(transformCtrl);

      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      
      const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
      dirLight.position.set(5, 10, 5);
      scene.add(dirLight);

      grid = new THREE.GridHelper(20, 20, 0x007AFF, 0xE5E5EA);
      grid.material.opacity = 0.2;
      grid.material.transparent = true;
      scene.add(grid);

      // Grid toggle
      document.getElementById('gridToggle').addEventListener('change', (e) => {
        grid.visible = e.target.checked;
      });

      setupXR();
      window.addEventListener('resize', onWindowResize);
      newDrawLayer();
      updateUnitOptions();
      renderer.setAnimationLoop(animate);

      setTimeout(() => {
        document.getElementById('loader').style.display = 'none';
      }, 500);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      cssRenderer.setSize(window.innerWidth, window.innerHeight);
    }

    function setupXR() {
      const vrBtn = document.getElementById('vrBtn');
      
      if ('xr' in navigator) {
        navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
          if (supported) {
            vrBtn.style.display = 'flex';
            vrBtn.addEventListener('click', onXRButtonClick);
          }
        });
      }

      renderer.xr.addEventListener('sessionstart', onXRSessionStart);
      renderer.xr.addEventListener('sessionend', onXRSessionEnd);
    }

    async function onXRButtonClick() {
      if (renderer.xr.isPresenting) {
        await renderer.xr.getSession().end();
      } else {
        try {
          const session = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['local-floor', 'hit-test'],
            optionalFeatures: ['dom-overlay', 'depth-sensing', 'hand-tracking'],
            domOverlay: { root: document.body },
            depthSensing: {
              usagePreference: ['cpu-optimized', 'gpu-optimized'],
              dataFormatPreference: ['luminance-alpha', 'float32']
            }
          });
          await renderer.xr.setSession(session);
        } catch (err) {
          console.error('XR failed:', err);
        }
      }
    }

    async function onXRSessionStart() {
      isLive = true;
      const session = renderer.xr.getSession();
      xrRefSpace = await session.requestReferenceSpace('local-floor');

      if (session.enabledFeatures?.includes('depth-sensing')) {
        const gl = renderer.getContext();
        xrGlBinding = new XRWebGLBinding(session, gl);
        
        depthTex = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, depthTex);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
      }

      closeAllPanels();
    }

    function onXRSessionEnd() {
      isLive = false;
      xrRefSpace = null;
      xrGlBinding = null;
    }

    window.togglePanel = function(panel) {
      const panels = ['layers', 'settings'];
      panels.forEach(p => {
        const el = document.getElementById(p + 'Panel');
        if (p === panel) {
          el.classList.toggle('active');
        } else {
          el.classList.remove('active');
        }
      });
    };

    function closeAllPanels() {
      document.getElementById('layersPanel').classList.remove('active');
      document.getElementById('settingsPanel').classList.remove('active');
      document.getElementById('controlsPanel').classList.remove('active');
    }

    window.updateUnitOptions = function() {
      // Unit conversion logic
    };

    window.newDrawLayer = function() {
      const layer = {
        id: Date.now(),
        name: `Capa ${drawLayers.length + 1}`,
        visible: true,
        points: []
      };
      drawLayers.push(layer);
      selectedDrawLayerIndex = drawLayers.length - 1;
      updateLayersList();
    };

    window.deleteSelectedDrawLayer = function() {
      if (selectedDrawLayerIndex >= 0 && selectedDrawLayerIndex < drawLayers.length) {
        drawLayers.splice(selectedDrawLayerIndex, 1);
        selectedDrawLayerIndex = Math.min(selectedDrawLayerIndex, drawLayers.length - 1);
        updateLayersList();
      }
    };

    function updateLayersList() {
      const list = document.getElementById('layersList');
      list.innerHTML = '';
      
      // Draw layers
      drawLayers.forEach((layer, idx) => {
        const item = document.createElement('div');
        item.className = 'layer-item';
        if (idx === selectedDrawLayerIndex) item.classList.add('active');
        
        item.innerHTML = `
          <div class="layer-icon">‚úèÔ∏è</div>
          <div class="layer-name">${layer.name}</div>
          <div class="layer-tag">draw</div>
          <button class="layer-vis">${layer.visible ? 'üëÅÔ∏è' : 'üö´'}</button>
        `;
        
        item.onclick = (e) => {
          if (!e.target.classList.contains('layer-vis')) {
            selectedDrawLayerIndex = idx;
            updateLayersList();
          }
        };
        
        const visBtn = item.querySelector('.layer-vis');
        visBtn.onclick = (e) => {
          e.stopPropagation();
          layer.visible = !layer.visible;
          updateLayersList();
        };
        
        list.appendChild(item);
      });
      
      // 3D objects
      objects.forEach(obj => {
        const item = document.createElement('div');
        item.className = 'layer-item';
        if (obj.id === activeId) item.classList.add('active');
        
        const icons = {
          'image': 'üñºÔ∏è',
          'video': 'üé¨',
          'youtube': '‚ñ∂Ô∏è',
          'gif': 'üé®',
          '360': 'üåê',
          'calibrator': 'üìè'
        };
        
        item.innerHTML = `
          <div class="layer-icon">${icons[obj.kind] || 'üì¶'}</div>
          <div class="layer-name">${obj.name}</div>
          <div class="layer-tag">${obj.kind}</div>
          <button class="layer-vis">${obj.visible ? 'üëÅÔ∏è' : 'üö´'}</button>
        `;
        
        item.onclick = (e) => {
          if (!e.target.classList.contains('layer-vis')) {
            activateObject(obj.id);
          }
        };
        
        const visBtn = item.querySelector('.layer-vis');
        visBtn.onclick = (e) => {
          e.stopPropagation();
          window.toggleObjectVisibility(obj.id);
        };
        
        list.appendChild(item);
      });
    }

    function activateObject(id) {
      activeId = id;
      const obj = objects.find(o => o.id === id);
      
      if (obj?.root3D) {
        transformCtrl.attach(obj.root3D);
        document.getElementById('controlsPanel').classList.add('active');
      } else {
        transformCtrl.detach();
        document.getElementById('controlsPanel').classList.remove('active');
      }
      
      updateLayersList();
      syncTransformToUI();
    }

    window.toggleObjectVisibility = function(id) {
      const obj = objects.find(o => o.id === id);
      if (obj) {
        obj.visible = !obj.visible;
        if (obj.root3D) obj.root3D.visible = obj.visible;
        updateLayersList();
      }
    };

    window.createCalibrator = function() {
      const geometry = new THREE.BoxGeometry(1, 0.05, 0.05);
      const material = new THREE.MeshStandardMaterial({ 
        color: 0xFF9F0A,
        emissive: 0xFF9F0A,
        emissiveIntensity: 0.3
      });
      const mesh = new THREE.Mesh(geometry, material);
      mesh.position.set(0, 1.5, -2);
      
      const obj = {
        id: Date.now(),
        kind: 'calibrator',
        name: 'Calibrador',
        visible: true,
        root3D: mesh,
        mesh: mesh
      };
      
      scene.add(mesh);
      objects.push(obj);
      updateLayersList();
    };

    window.startNewMeasure = function() {
      measureMode = true;
      measurePoints = [];
    };

    window.clearAllMeasures = function() {
      measureLines.forEach(line => scene.remove(line));
      measureLines = [];
      measurePoints = [];
    };

    window.addImageLayer = function() {
      const url = prompt('URL:');
      if (!url) return;
      
      const texture = new THREE.TextureLoader().load(url);
      const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });
      const geometry = new THREE.PlaneGeometry(2, 1.5);
      const mesh = new THREE.Mesh(geometry, material);
      mesh.position.set(0, 1.6, -2);
      
      const obj = {
        id: Date.now(),
        kind: 'image',
        name: 'Imagen',
        visible: true,
        root3D: mesh,
        mesh: mesh,
        tex: texture,
        mat: material
      };
      
      scene.add(mesh);
      objects.push(obj);
      updateLayersList();
    };

    window.addVideoLayer = function() {
      const url = prompt('URL:');
      if (!url) return;
      
      const video = document.createElement('video');
      video.src = url;
      video.crossOrigin = 'anonymous';
      video.loop = true;
      video.muted = true;
      video.play();
      
      const texture = new THREE.VideoTexture(video);
      const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });
      const geometry = new THREE.PlaneGeometry(3, 2);
      const mesh = new THREE.Mesh(geometry, material);
      mesh.position.set(0, 1.6, -2);
      
      const obj = {
        id: Date.now(),
        kind: 'video',
        name: 'Video',
        visible: true,
        root3D: mesh,
        mesh: mesh,
        tex: texture,
        mat: material,
        video: video
      };
      
      scene.add(mesh);
      objects.push(obj);
      updateLayersList();
    };

    function syncTransformToUI() {
      const obj = objects.find(o => o.id === activeId);
      if (!obj?.root3D) return;
      
      const p = obj.root3D.position;
      const s = obj.root3D.scale;
      const r = obj.root3D.rotation;
      
      ['X', 'Y', 'Z'].forEach(ax => {
        const lax = ax.toLowerCase();
        if (document.getElementById(`pos${ax}`)) {
          document.getElementById(`pos${ax}`).value = p[lax];
          document.getElementById(`v_pos${ax}`).textContent = p[lax].toFixed(2);
        }
        if (document.getElementById(`rot${ax}`)) {
          document.getElementById(`rot${ax}`).value = r[lax];
          document.getElementById(`v_rot${ax}`).textContent = r[lax].toFixed(2);
        }
      });
      
      ['X', 'Y'].forEach(ax => {
        const lax = ax.toLowerCase();
        if (document.getElementById(`sc${ax}`)) {
          document.getElementById(`sc${ax}`).value = s[lax];
          document.getElementById(`v_sc${ax}`).textContent = s[lax].toFixed(2);
        }
      });
    }

    ['X', 'Y', 'Z'].forEach(ax => {
      const lax = ax.toLowerCase();
      window[`onPos${ax}`] = function(v) {
        const o = objects.find(x => x.id === activeId);
        if (o?.root3D) {
          o.root3D.position[lax] = v;
          document.getElementById(`v_pos${ax}`).textContent = v.toFixed(2);
        }
      };
      window[`onRot${ax}`] = function(v) {
        const o = objects.find(x => x.id === activeId);
        if (o?.root3D) {
          o.root3D.rotation[lax] = v;
          document.getElementById(`v_rot${ax}`).textContent = v.toFixed(2);
        }
      };
    });

    ['X', 'Y'].forEach(ax => {
      const lax = ax.toLowerCase();
      window[`onSc${ax}`] = function(v) {
        const o = objects.find(x => x.id === activeId);
        if (o?.root3D) {
          o.root3D.scale[lax] = v;
          document.getElementById(`v_sc${ax}`).textContent = v.toFixed(2);
        }
      };
    });

    function animate(time, frame) {
      orbit.update();
      
      objects.forEach(o => {
        if (o.kind === 'gif' && o.gifData?.playing) {
          const g = o.gifData;
          if (performance.now() > g.nextTime) {
            g.r.decodeAndBlitFrameRGBA(g.f, g.dat.data);
            g.ctx.putImageData(g.dat, 0, 0);
            g.tex.needsUpdate = true;
            
            const d = g.r.frameInfo(g.f).delay * 10;
            g.nextTime = performance.now() + (d || 100);
            g.f = (g.f + 1) % g.r.numFrames();
          }
        }
        
        if (o.kind === 'youtube' && o.cssObj && o.root3D) {
          o.cssObj.position.copy(o.root3D.position);
          o.cssObj.quaternion.copy(o.root3D.quaternion);
          o.cssObj.scale.copy(o.root3D.scale).multiplyScalar(1/960);
        }
      });
      
      if (frame && xrGlBinding && document.getElementById('checkOcclusion').checked) {
        const pose = frame.getViewerPose(xrRefSpace);
        if (pose) {
          const gl = renderer.getContext();
          gl.colorMask(false, false, false, false);
          
          for (const view of pose.views) {
            const dInfo = xrGlBinding.getDepthInformation(view);
            if (dInfo) {
              gl.bindTexture(gl.TEXTURE_2D, depthTex);
              gl.texImage2D(gl.TEXTURE_2D, 0, gl.LUMINANCE_ALPHA, dInfo.width, dInfo.height, 0, gl.LUMINANCE_ALPHA, gl.UNSIGNED_BYTE, dInfo.data);
            }
          }
          
          gl.colorMask(true, true, true, true);
        }
      }
      
      renderer.render(scene, camera);
      cssRenderer.render(scene, camera);
    }

    init();
  </script>
</body>
</html>
