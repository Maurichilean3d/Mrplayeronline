<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>MR Studio Diamond v14.0 | Architect Pro</title>
  
  <script src="https://unpkg.com/omggif@1.0.10/omggif.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    /* ESTILO MODERNO "GLASS" */
    * { box-sizing: border-box; user-select: none; font-family: 'Segoe UI', system-ui, sans-serif; }
    body { margin: 0; overflow: hidden; background: transparent; color: #eee; }
    #c { position: fixed; inset: 0; width: 100%; height: 100%; touch-action: none; z-index: 0; }
    
    .ui-panel { 
      position: fixed; left: 20px; top: 20px; width: 360px; max-height: 90vh; 
      background: rgba(15, 15, 20, 0.85); backdrop-filter: blur(25px); 
      border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; 
      padding: 20px; overflow-y: auto; z-index: 100; 
      box-shadow: 0 20px 50px rgba(0,0,0,0.6);
      scrollbar-width: thin; scrollbar-color: #555 transparent;
      transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .ui-panel.minimized { transform: translateX(-420px); }
    
    h2 { margin: 0 0 20px 0; font-size: 16px; color: #fff; font-weight: 700; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; }
    .sec-head { font-size: 10px; font-weight: 800; color: #888; margin: 15px 0 8px 0; text-transform: uppercase; letter-spacing: 1.5px; }
    
    .row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    label { font-size: 11px; flex: 1; color: #ccc; }
    input[type=range] { flex: 2; height: 3px; accent-color: #00d2ff; cursor: pointer; background: #333; border-radius: 2px; }
    input[type=checkbox] { width: 14px; height: 14px; accent-color: #00d2ff; cursor: pointer; }
    .val { width: 35px; text-align: right; font-size: 10px; color: #00d2ff; font-family: monospace; }
    
    /* BOTONES ESTILIZADOS */
    button { flex: 1; padding: 10px; border-radius: 8px; border: none; font-size: 11px; font-weight: 600; cursor: pointer; color: white; background: #2a2a30; transition: 0.2s; border: 1px solid rgba(255,255,255,0.05); }
    button:active { transform: scale(0.96); }
    button.primary { background: #00d2ff; color: #000; box-shadow: 0 0 15px rgba(0, 210, 255, 0.3); }
    button.drive-btn { background: #0F9D58; color: white; }
    
    select, input[type=url] { width: 100%; background: #1a1a20; border: 1px solid #333; color: #eee; padding: 8px; border-radius: 8px; font-size: 11px; outline: none; }

    #toggleUI { position: fixed; left: 20px; top: 20px; z-index: 101; width: 40px; height: 40px; border-radius: 50%; background: #222; border: 1px solid #444; color: white; cursor: pointer; display: none; }
    #vrBtn { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); padding: 12px 30px; background: #00d2ff; color: #000; border-radius: 50px; font-weight: 800; z-index: 1000; display: none; box-shadow: 0 0 30px rgba(0, 210, 255, 0.5); border: 2px solid white; letter-spacing: 1px; }
    .loader { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; place-items: center; color: #00d2ff; font-weight: 900; letter-spacing: 2px; }
    
    /* COLOR PICKER CUSTOM */
    .color-btn { width: 20px; height: 20px; border-radius: 4px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); }
    #currentColorBox { width: 100%; height: 6px; border-radius: 3px; background: #0f0; margin-bottom: 10px; }
  </style>
</head>
<body>

<canvas id="c"></canvas>
<div class="loader" id="loader">CARGANDO...</div>
<button id="toggleUI" onclick="toggleUIPanel()">‚ò∞</button>

<div class="ui-panel" id="ui">
  <h2>DIAMOND v14.0 <button style="width:auto; padding:4px 8px; background:transparent;" onclick="toggleUIPanel()">√ó</button></h2>

  <div class="sec-head">üìê Arquitectura</div>
  <div class="row">
      <select id="unitSystem" onchange="updateUnits()">
          <option value="m">Metros (m)</option>
          <option value="cm">Cent√≠metros (cm)</option>
          <option value="ft">Pies (ft)</option>
      </select>
  </div>
  <div class="row">
      <label><input type="checkbox" id="showGrid" checked onchange="updateGrid()"> Grilla</label>
      <label><input type="checkbox" id="showGhost" checked> Guias Fantasma</label>
  </div>
  
  <div class="sec-head">üîí Escala (Mano Izq)</div>
  <div class="row" style="font-size:10px; color:#aaa;">
      <label><input type="checkbox" id="lockX"> Bloq X</label>
      <label><input type="checkbox" id="lockY"> Bloq Y</label>
      <label><input type="checkbox" id="lockZ"> Bloq Z</label>
  </div>

  <div class="sec-head">‚òÅÔ∏è Proyecto</div>
  <div class="row" id="authPanel"><button onclick="handleAuthClick()" class="drive-btn">CONECTAR DRIVE</button></div>
  <div class="row" id="driveActions" style="display:none; gap:5px;">
      <button onclick="saveSceneToDrive()">GUARDAR</button>
      <button onclick="loadSceneFromDrive()">CARGAR</button>
  </div>

  <div class="sec-head">üì• Assets</div>
  <div class="row">
    <input type="url" id="webUrl" placeholder="URL .mp4 / .png">
    <button class="primary" onclick="loadFromWeb()" style="width:50px;">+</button>
  </div>
  <button onclick="document.getElementById('fileInput').click()" style="width:100%; margin-top:5px;">üìÅ ARCHIVO LOCAL</button>
  <input type="file" id="fileInput" multiple style="display:none;">

  <div id="editorUI" style="display:none;">
    <div class="sec-head">üé® Imagen</div>
    <div class="row"><label>Brillo</label><input type="range" id="brightness" min="-1" max="1" step="0.05" value="0"></div>
    <div class="row"><label>Contraste</label><input type="range" id="contrast" min="0" max="3" step="0.1" value="1"></div>
    <div class="row"><label>Opacidad</label><input type="range" id="opacity" min="0" max="1" step="0.01" value="1"></div>
    
    <div class="sec-head">üõ†Ô∏è Chroma Key</div>
    <div class="row"><label><input type="checkbox" id="chromaToggle"> Activar</label></div>
    <div id="chromaPanel" style="display:none; background:rgba(255,255,255,0.03); padding:10px; border-radius:8px;">
        <div id="currentColorBox"></div>
        <div class="row" style="justify-content: space-around;">
            <div class="color-btn" style="background:#00ff00;" onclick="setChromaPreset(0,1,0)"></div>
            <div class="color-btn" style="background:#0000ff;" onclick="setChromaPreset(0,0,1)"></div>
            <div class="color-btn" style="background:#000000;" onclick="setChromaPreset(0,0,0)"></div>
        </div>
        <div class="row"><label>Rango</label><input type="range" id="k1sim" min="0" max="0.8" step="0.01"></div>
        <div class="row"><label>Suave</label><input type="range" id="k1smooth" min="0" max="0.4" step="0.01"></div>
    </div>
    
    <div class="row" style="margin-top:15px; gap:5px;">
        <button onclick="mediaAction('play')">‚ñ∂ PLAY</button>
        <button onclick="mediaAction('pause')">‚è∏ PAUSE</button>
        <button class="danger" onclick="deleteActive()" style="background:#300; color:#f55; border-color:#f00;">BORRAR</button>
    </div>
  </div>

  <div class="sec-head">‚öôÔ∏è Avanzado</div>
  <div class="row"><label><input type="checkbox" id="checkOcclusion"> Oclusi√≥n Depth API</label></div>
</div>

<button id="vrBtn">INICIAR ARQUITECTO MR</button>

<script type="importmap">
{ "imports": {
  "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
  "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
} }
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { TransformControls } from 'three/addons/controls/TransformControls.js';
import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';

// CREDENCIALES (Poner las tuyas)
const CLIENT_ID = ''; const API_KEY = ''; const SCOPES = 'https://www.googleapis.com/auth/drive.file';

// ==========================================
// üåë OCLUSI√ìN SHADERS (DEPTH API)
// ==========================================
const depthVS = `#version 300 es
in vec2 aPos; out vec2 vUv; void main(){ vUv = aPos * 0.5 + 0.5; gl_Position = vec4(aPos, 0.0, 1.0); }`;
const depthFS = `#version 300 es
precision highp float; precision highp sampler2D; in vec2 vUv; uniform sampler2D uDepth; uniform float uRawToMeters; uniform mat4 uProj; out vec4 outColor;
float decode(vec4 la){ return (la.r * 255.0 * 256.0 + la.a * 255.0); }
void main(){ 
  float zMeters = decode(texture(uDepth, vUv)) * uRawToMeters; if(zMeters <= 0.0) discard;
  float z = -zMeters; float clipZ = uProj[2][2] * z + uProj[3][2]; float clipW = uProj[2][3] * z + uProj[3][3];
  gl_FragDepth = clamp((clipZ / clipW) * 0.5 + 0.5, 0.0, 1.0); outColor = vec4(0.0); 
}`;

// ==========================================
// üé® PRO SHADER (VIDEO/IMAGEN)
// ==========================================
const vShader = `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`;
const fShader = `
uniform sampler2D map; uniform float uBrightness, uContrast, uSaturation, uOpacity;
uniform bool chromaOn; uniform vec3 k1; uniform float sim1, smooth1;
varying vec2 vUv;
void main() {
  vec4 tex = texture2D(map, vUv); float alpha = tex.a * uOpacity;
  if(chromaOn) { float d = distance(tex.rgb, k1); alpha *= smoothstep(sim1, sim1 + smooth1, d); }
  vec3 col = tex.rgb + uBrightness; col = (col - 0.5) * uContrast + 0.5;
  float gray = dot(col, vec3(0.299, 0.587, 0.114)); col = mix(vec3(gray), col, uSaturation);
  gl_FragColor = vec4(col, alpha); if(alpha < 0.01) discard; 
}`;

// ==========================================
// ‚öôÔ∏è SISTEMA PRINCIPAL
// ==========================================
let scene, camera, renderer, orbit, transformCtrl, xrSession, xrRefSpace;
let objects = [], activeId = null;
let clock = new THREE.Clock();
let xrGlBinding = null, depthProgram = null, depthVao = null, depthTex = null, occlusionEnabled = false;

// UI & XR
let controller1, controller2, controllerGrip1, controllerGrip2, raycaster;
const tempMatrix = new THREE.Matrix4();
let uiGhosts = { x:null, y:null, z:null }, uiLabels = [], gridHelper;
let inspectorBox = null;
let currentUnit = 'm';

function init() {
  scene = new THREE.Scene();
  scene.add(new THREE.AmbientLight(0xffffff, 1));
  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 500);
  camera.position.set(0, 1.6, 2);

  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('c'), antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.xr.enabled = true;

  orbit = new OrbitControls(camera, renderer.domElement);
  
  transformCtrl = new TransformControls(camera, renderer.domElement);
  transformCtrl.addEventListener('dragging-changed', e => orbit.enabled = !e.value);
  scene.add(transformCtrl);
  
  initArchitectVisuals();
  updateGrid(); 
  setupXRControllers();
  setupVR();
  
  renderer.setAnimationLoop(animate);
  
  // UI Bindings
  document.getElementById('keyR').addEventListener('input', updateChromaManual);
  document.getElementById('keyG').addEventListener('input', updateChromaManual);
  document.getElementById('keyB').addEventListener('input', updateChromaManual);
  document.getElementById('chromaToggle').addEventListener('change', updateMaterial);
  document.querySelectorAll('input[type=range]').forEach(i => {
      if(!i.id.startsWith('key')) i.addEventListener('input', e => updateMaterialParam(e.target.id, parseFloat(e.target.value)));
  });
  
  window.updateUnits = () => { currentUnit = document.getElementById('unitSystem').value; updateGrid(); };
  window.updateGrid = updateGrid;
  window.setChromaPreset = (r,g,b) => { document.getElementById('keyR').value=r; document.getElementById('keyG').value=g; document.getElementById('keyB').value=b; updateChromaManual(); };
}

// ==========================================
// üèóÔ∏è ARQUITECTO UI (GHOST PLANES + INSPECTOR)
// ==========================================
function initArchitectVisuals() {
    // 1. Paneles Fantasma (Blancos transparentes)
    const planeGeo = new THREE.PlaneGeometry(1, 1);
    const planeMat = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.0, side: THREE.DoubleSide, depthTest: false });
    
    uiGhosts.x = new THREE.Mesh(planeGeo, planeMat.clone()); // Lateral
    uiGhosts.z = new THREE.Mesh(planeGeo, planeMat.clone()); // Frontal
    uiGhosts.y = new THREE.Mesh(planeGeo, planeMat.clone()); // Piso
    uiGhosts.y.rotation.x = -Math.PI / 2;
    
    scene.add(uiGhosts.x); scene.add(uiGhosts.z); scene.add(uiGhosts.y);

    // 2. Inspector Box (Wireframe)
    inspectorBox = new THREE.BoxHelper(new THREE.Mesh(), 0x00ffff);
    inspectorBox.visible = false;
    scene.add(inspectorBox);

    // 3. Etiquetas Flotantes (Dimensiones)
    for(let i=0; i<3; i++) {
        const spr = createTextSprite();
        uiLabels.push(spr);
        scene.add(spr);
    }
}

function createTextSprite() {
    const cvs = document.createElement('canvas'); cvs.width = 256; cvs.height = 64;
    const tex = new THREE.CanvasTexture(cvs);
    const mat = new THREE.SpriteMaterial({ map: tex, transparent: true, depthTest: false });
    const s = new THREE.Sprite(mat); s.scale.set(0.4, 0.1, 1); s.visible = false;
    s.userData = { cvs, ctx: cvs.getContext('2d'), tex };
    return s;
}

function updateLabel(sprite, text, pos) {
    const { ctx, tex } = sprite.userData;
    ctx.clearRect(0,0,256,64);
    // Estilo "Glass" moderno
    ctx.fillStyle = "rgba(10, 10, 20, 0.8)"; 
    ctx.beginPath(); ctx.roundRect(10, 5, 236, 54, 15); ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.2)"; ctx.lineWidth = 2; ctx.stroke();
    
    ctx.fillStyle = "#fff"; ctx.font = "bold 32px Segoe UI"; 
    ctx.textAlign = "center"; ctx.textBaseline = "middle";
    ctx.fillText(text, 128, 32);
    tex.needsUpdate = true;
    sprite.position.copy(pos);
    sprite.visible = true;
}

function convert(val) {
    if(currentUnit==='cm') return (val*100).toFixed(1)+' cm';
    if(currentUnit==='ft') return (val*3.28).toFixed(2)+' ft';
    return val.toFixed(2)+' m';
}

function updateGrid() {
    const old = scene.getObjectByName("grid"); if(old) scene.remove(old);
    if(!document.getElementById('showGrid').checked) return;
    let sz = 10, d = 10;
    if(currentUnit==='ft') { sz = 3.048; d = 10; }
    gridHelper = new THREE.GridHelper(sz, d, 0x444444, 0x222222);
    gridHelper.name = "grid"; scene.add(gridHelper);
}

// ==========================================
// üéÆ CONTROLES XR PRO (LOGICA V14)
// ==========================================
function setupXRControllers() {
    // DERECHA (0)
    controller1 = renderer.xr.getController(0);
    controller1.addEventListener('selectstart', onSelectStart); // Gatillo: Seleccionar UI
    controller1.addEventListener('squeezestart', onGripStart);  // Grip: Mover
    controller1.addEventListener('squeezeend', onGripEnd);
    // Listener para Bot√≥n A (Index 4) para INSPECTOR
    controller1.addEventListener('connected', (e) => {
        e.data.gamepad.onbuttondown = (b) => { if(b.button === 4) toggleInspector(); };
    });
    scene.add(controller1);

    // IZQUIERDA (1)
    controller2 = renderer.xr.getController(1);
    controller2.addEventListener('selectstart', onSelectStart);
    controller2.addEventListener('squeezestart', onGripStart);
    controller2.addEventListener('squeezeend', onGripEnd);
    // Listener para Bot√≥n Y (Index 4/5) para TUTORIAL
    controller2.addEventListener('connected', (e) => {
        e.data.gamepad.onbuttondown = (b) => { if(b.button === 4 || b.button === 5) showTutorial(); };
    });
    scene.add(controller2);

    // Modelos y Rayos
    const fac = new XRControllerModelFactory();
    controllerGrip1 = renderer.xr.getControllerGrip(0); controllerGrip1.add(fac.createControllerModel(controllerGrip1)); scene.add(controllerGrip1);
    controllerGrip2 = renderer.xr.getControllerGrip(1); controllerGrip2.add(fac.createControllerModel(controllerGrip2)); scene.add(controllerGrip2);

    const geo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,0,-5)]);
    const line = new THREE.Line(geo); line.scale.z = 5;
    controller1.add(line.clone()); controller2.add(line.clone());
    raycaster = new THREE.Raycaster();
}

function handleArchitectInteraction() {
    const s = renderer.xr.getSession();
    if(!s || !activeId) { resetGhosts(); return; }
    
    const obj = objects.find(o => o.id === activeId);
    if(!obj) return;

    let interacting = false;

    for(const src of s.inputSources) {
        if(!src.gamepad) continue;
        const gp = src.gamepad;
        const grip = gp.buttons[1].pressed;
        const ax = gp.axes[2], ay = gp.axes[3];

        // --- MANO DERECHA (MOVER / ROTAR) ---
        if(src.handedness === 'right' && grip) {
            interacting = true;
            // Ghost Planes Activos
            updateGhosts(obj.mesh, true);
            
            // Rayo Tractor (Stick Y)
            if(Math.abs(ay) > 0.1) {
                const dir = new THREE.Vector3().subVectors(obj.mesh.position, camera.position).normalize();
                dir.y = 0; // Mantener altura al acercar
                obj.mesh.position.addScaledVector(dir, ay * -0.05);
            }
            // Rotar (Stick X)
            if(Math.abs(ax) > 0.1) {
                obj.mesh.rotation.y -= ax * 0.05;
                // Mostrar √°ngulo en etiqueta 0
                const deg = Math.round(THREE.MathUtils.radToDeg(obj.mesh.rotation.y) % 360);
                updateLabel(uiLabels[0], deg+"¬∞", obj.mesh.position.clone().add(new THREE.Vector3(0,0.5,0)));
            }
        }

        // --- MANO IZQUIERDA (ESCALA) ---
        if(src.handedness === 'left' && grip) {
            interacting = true;
            if(Math.abs(ay) > 0.1) {
                let f = 1 - (ay * 0.02);
                if(f < 0.1) f = 0.1; // ANTI-CRASH PROTECTION
                
                const lx = document.getElementById('lockX').checked;
                const ly = document.getElementById('lockY').checked;
                const lz = document.getElementById('lockZ').checked;
                
                if(!lx) obj.mesh.scale.x *= f;
                if(!ly) obj.mesh.scale.y *= f;
                if(!lz) obj.mesh.scale.z *= f;
                
                obj.mesh.scale.clampScalar(0.01, 50); // Hard clamp
                
                // Mostrar escala en etiqueta 0
                updateLabel(uiLabels[0], "x"+obj.mesh.scale.x.toFixed(2), obj.mesh.position);
            }
        }
    }

    if(!interacting) resetGhosts();
}

function updateGhosts(mesh, visible) {
    const p = mesh.position;
    const s = mesh.scale;
    // Paneles blancos transparentes que siguen al objeto
    uiGhosts.x.position.set(p.x, p.y, 0); // Proyecci√≥n pared fondo
    uiGhosts.x.scale.set(5, 5, 1);
    uiGhosts.x.material.opacity = visible ? 0.1 : 0;

    uiGhosts.z.position.set(0, p.y, p.z); // Proyecci√≥n pared lateral
    uiGhosts.z.rotation.y = Math.PI/2;
    uiGhosts.z.scale.set(5, 5, 1);
    uiGhosts.z.material.opacity = visible ? 0.1 : 0;
    
    uiGhosts.y.position.set(p.x, 0.01, p.z); // Piso
    uiGhosts.y.scale.set(2, 2, 1);
    uiGhosts.y.material.opacity = visible ? 0.2 : 0;
}

function resetGhosts() {
    uiGhosts.x.material.opacity = 0;
    uiGhosts.z.material.opacity = 0;
    uiGhosts.y.material.opacity = 0;
    uiLabels.forEach(l => l.visible = false);
}

// --- INSPECTOR DE DIMENSIONES (Caja Cian) ---
function toggleInspector() {
    if(!activeId) return;
    const obj = objects.find(o => o.id === activeId);
    inspectorBox.visible = !inspectorBox.visible;
    if(inspectorBox.visible) {
        inspectorBox.setFromObject(obj.mesh);
        // Calcular dimensiones reales
        const box = new THREE.Box3().setFromObject(obj.mesh);
        const sz = new THREE.Vector3(); box.getSize(sz);
        // Mostrar etiquetas en bordes
        updateLabel(uiLabels[0], convert(sz.x), box.max.clone().setY(box.min.y)); // Ancho
        updateLabel(uiLabels[1], convert(sz.y), box.max); // Alto
        updateLabel(uiLabels[2], convert(sz.z), box.min); // Profundidad
    } else {
        uiLabels.forEach(l => l.visible = false);
    }
}

function showTutorial() {
    // Podr√≠a lanzar una imagen, por ahora usamos una etiqueta
    updateLabel(uiLabels[0], "Izquierda: Escala | Derecha: Mover", camera.position.clone().add(new THREE.Vector3(0,0,-1)));
}

// ==========================================
// üñ±Ô∏è INTERACCI√ìN B√ÅSICA
// ==========================================
function onGripStart(e) {
    const c = e.target;
    const hits = getIntersections(c);
    if(hits.length > 0) {
        const o = hits[0].object;
        c.attach(o);
        c.userData.selected = o;
    }
}
function onGripEnd(e) {
    const c = e.target;
    if(c.userData.selected) {
        scene.attach(c.userData.selected);
        c.userData.selected = null;
    }
}
function onSelectStart(e) {
    const hits = getIntersections(e.target);
    if(hits.length > 0 && hits[0].object.userData.id) selectObject(hits[0].object.userData.id);
}
function getIntersections(c) {
    tempMatrix.identity().extractRotation(c.matrixWorld);
    raycaster.ray.origin.setFromMatrixPosition(c.matrixWorld);
    raycaster.ray.direction.set(0, 0, -1).applyMatrix4(tempMatrix);
    return raycaster.intersectObjects(objects.map(o=>o.mesh), false);
}

// ==========================================
// üì¶ ASSET LOADER UNIFICADO
// ==========================================
async function addAsset(url, type, name, isGif=false, isRestore=false) {
  if(!isRestore) document.getElementById('loader').style.display='grid';
  let tex, mesh, gifData=null, video=null, newObj=null;
  try {
    if(isGif) {
        const buf = await (await fetch(url)).arrayBuffer();
        const r = new window.Omggif.GifReader(new Uint8Array(buf));
        const cvs=document.createElement('canvas'); cvs.width=r.width; cvs.height=r.height;
        const ctx=cvs.getContext('2d'); const dat=ctx.createImageData(r.width,r.height);
        tex=new THREE.CanvasTexture(cvs); tex.colorSpace=THREE.SRGBColorSpace;
        gifData={r, ctx, dat, tex, f:0, nextTime:0, playing:true};
    } else if(type==='video') {
        video=document.createElement('video'); video.src=url; video.crossOrigin='anonymous'; video.loop=true; video.muted=true; video.playsInline=true;
        await video.play(); tex=new THREE.VideoTexture(video); tex.colorSpace=THREE.SRGBColorSpace;
    } else {
        tex=await new THREE.TextureLoader().loadAsync(url); tex.colorSpace=THREE.SRGBColorSpace;
    }
    const ar = video ? video.videoWidth/video.videoHeight : (tex.image?tex.image.width/tex.image.height:1.77);
    const mat = new THREE.ShaderMaterial({
        uniforms: { map:{value:tex}, uBrightness:{value:0}, uContrast:{value:1}, uSaturation:{value:1}, uOpacity:{value:1}, chromaOn:{value:false}, k1:{value:new THREE.Color(0,1,0)}, sim1:{value:0.4}, smooth1:{value:0.08} },
        vertexShader: vShader, fragmentShader: fShader, transparent:true, side:THREE.DoubleSide, depthWrite:false
    });
    mesh = new THREE.Mesh(new THREE.PlaneGeometry(ar, 1), mat);
    mesh.position.set(0, 1.6, -2);
    mesh.userData.id = Math.random().toString(36).substr(2,9);
    newObj = { id:mesh.userData.id, name, mesh, video, gifData, type, billboard:false, originalAspect:ar, sourceUrl:url };
    objects.push(newObj); scene.add(mesh);
    if(!isRestore) selectObject(newObj.id);
  } catch(e){ console.error(e); }
  if(!isRestore) document.getElementById('loader').style.display='none';
  return newObj;
}

// ==========================================
// üîÅ LOOP PRINCIPAL
// ==========================================
function animate(time, frame) {
  const dt = clock.getElapsedTime();
  orbit.update();
  handleArchitectInteraction();
  
  if(inspectorBox.visible && activeId) {
      const o = objects.find(ob=>ob.id===activeId);
      if(o) inspectorBox.update(o.mesh);
  }

  objects.forEach(o => {
      if(o.billboard) o.mesh.lookAt(camera.position.x, o.mesh.position.y, camera.position.z);
      if(o.gifData && o.gifData.playing && performance.now() > o.gifData.nextTime) {
          const g=o.gifData; g.r.decodeAndBlitFrameRGBA(g.f, g.dat.data); g.ctx.putImageData(g.dat,0,0);
          g.tex.needsUpdate=true; g.nextTime=performance.now()+100; g.f=(g.f+1)%g.r.numFrames();
      }
  });

  // OCLUSI√ìN DEPTH API
  if(frame && occlusionEnabled && xrGlBinding) {
      const pose = frame.getViewerPose(xrRefSpace);
      if(pose) {
          const gl = renderer.getContext();
          gl.colorMask(false,false,false,false);
          for(const view of pose.views) {
              const dInfo = xrGlBinding.getDepthInformation(view);
              if(dInfo) {
                  gl.bindTexture(gl.TEXTURE_2D, depthTex);
                  gl.texImage2D(gl.TEXTURE_2D,0,gl.LUMINANCE_ALPHA, dInfo.width, dInfo.height, 0, gl.LUMINANCE_ALPHA, gl.UNSIGNED_BYTE, dInfo.data);
                  gl.useProgram(depthProgram);
                  gl.uniform1f(gl.getUniformLocation(depthProgram,'uRawToMeters'), dInfo.rawValueToMeters);
                  gl.uniformMatrix4fv(gl.getUniformLocation(depthProgram,'uProj'), false, view.projectionMatrix);
                  gl.bindVertexArray(depthVao); gl.drawArrays(gl.TRIANGLES,0,6);
              }
          }
          gl.colorMask(true,true,true,true);
      }
  }
  renderer.render(scene, camera);
}

// SETUP VR & OCLUSI√ìN
function setupVR() {
  if(navigator.xr) navigator.xr.isSessionSupported('immersive-ar').then(ok => {
      if(ok) {
          const btn = document.getElementById('vrBtn'); btn.style.display='block';
          btn.onclick = async () => {
              occlusionEnabled = document.getElementById('checkOcclusion').checked;
              const feat = ['local-floor']; const opt = ['dom-overlay'];
              if(occlusionEnabled) { opt.push('depth-sensing'); }
              xrSession = await navigator.xr.requestSession('immersive-ar', { requiredFeatures:feat, optionalFeatures:opt, domOverlay:{root:document.body}, depthSensing:{usagePreference:['cpu-optimized'], dataFormatPreference:['luminance-alpha']} });
              renderer.xr.setSession(xrSession); xrRefSpace = await xrSession.requestReferenceSpace('local-floor');
              if(occlusionEnabled) initDepthOcclusion(xrSession);
          };
      }
  });
}
function initDepthOcclusion(s) {
    const gl=renderer.getContext(); xrGlBinding=new XRWebGLBinding(s,gl);
    const vs=gl.createShader(gl.VERTEX_SHADER); gl.shaderSource(vs,depthVS); gl.compileShader(vs);
    const fs=gl.createShader(gl.FRAGMENT_SHADER); gl.shaderSource(fs,depthFS); gl.compileShader(fs);
    depthProgram=gl.createProgram(); gl.attachShader(depthProgram,vs); gl.attachShader(depthProgram,fs); gl.linkProgram(depthProgram);
    depthVao=gl.createVertexArray(); gl.bindVertexArray(depthVao);
    const vbo=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,vbo);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, 1,-1, -1,1, -1,1, 1,-1, 1,1]), gl.STATIC_DRAW);
    const loc=gl.getAttribLocation(depthProgram,'aPos'); gl.enableVertexAttribArray(loc); gl.vertexAttribPointer(loc,2,gl.FLOAT,false,0,0);
    depthTex=gl.createTexture();
}

// UI HELPERS
function updateMaterialParam(id, v) { const o=objects.find(x=>x.id===activeId); if(o) o.mesh.material.uniforms[id==='brightness'?'uBrightness':id==='contrast'?'uContrast':'uOpacity'].value=v; }
function updateChromaManual() { const o=objects.find(x=>x.id===activeId); if(o) { o.mesh.material.uniforms.k1.value.setRGB(parseFloat(document.getElementById('keyR').value), parseFloat(document.getElementById('keyG').value), parseFloat(document.getElementById('keyB').value)); document.getElementById('currentColorBox').style.backgroundColor='#'+o.mesh.material.uniforms.k1.value.getHexString(); }}
function updateMaterial() { const o=objects.find(x=>x.id===activeId); if(o) { o.mesh.material.uniforms.chromaOn.value = document.getElementById('chromaToggle').checked; document.getElementById('chromaPanel').style.display=o.mesh.material.uniforms.chromaOn.value?'block':'none'; updateChromaManual(); }}
function selectObject(id) { activeId=id; const o=objects.find(x=>x.id===id); if(o) { transformCtrl.attach(o.mesh); document.getElementById('editorUI').style.display='block'; updateLayers(); document.getElementById('checkBillboard').checked=o.billboard; document.getElementById('chromaToggle').checked=o.mesh.material.uniforms.chromaOn.value; updateMaterial(); } }
function updateLayers() { const l=document.getElementById('layerList'); l.innerHTML=''; objects.forEach(o=>{ const d=document.createElement('div'); d.className=`layer-item ${o.id===activeId?'active':''}`; d.innerText=(o.type=='video'?'üé¨ ':'üñºÔ∏è ')+o.name.slice(0,15); d.onclick=()=>selectObject(o.id); l.appendChild(d); }); }
window.toggleUIPanel = () => document.getElementById('ui').classList.toggle('minimized');
window.handleAuthClick = () => { if(!CLIENT_ID) alert("Falta API KEY"); gapi.load('client:auth2', ()=>{ gapi.client.init({apiKey:API_KEY, clientId:CLIENT_ID, discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"], scope:SCOPES}).then(()=>gapi.auth2.getAuthInstance().signIn()).then(()=>{ document.getElementById('authPanel').style.display='none'; document.getElementById('driveActions').style.display='flex'; }); }); };
window.saveSceneToDrive = () => { /* Logica guardar */ };
window.loadSceneFromDrive = () => { /* Logica cargar */ };
window.loadFromWeb = () => { const u=document.getElementById('webUrl').value; if(u) addAsset(u, u.match(/\.(mp4|webm)/i)?'video':'image', 'Web Asset'); };
document.getElementById('fileInput').onchange = (e) => { for(let f of e.target.files) addAsset(URL.createObjectURL(f), f.type.includes('video')?'video':'image', f.name, f.name.includes('.gif')); };
window.deleteActive = () => { const i=objects.findIndex(x=>x.id===activeId); if(i>-1) { scene.remove(objects[i].mesh); objects.splice(i,1); transformCtrl.detach(); document.getElementById('editorUI').style.display='none'; updateLayers(); inspectorBox.visible=false; } };
window.mediaAction = (a) => { const o=objects.find(x=>x.id===activeId); if(o&&o.video) a=='play'?o.video.play():o.video.pause(); };

init();
</script>
</body>
</html>
