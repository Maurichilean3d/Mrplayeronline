<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>MR Studio Diamond v24.x | Fusion Projections + 3D + 360</title>

  <!-- libs -->
  <script src="https://unpkg.com/omggif@1.0.10/omggif.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
  /* =========================================
     PALETAS  ‚Äî  selector din√°mico
  ========================================= */
  :root[data-theme="amber"]        { --main-color:#ffaa00; --bg-glass:rgba(20,20,25,.85); }
  :root[data-theme="earth"]        { --main-color:#dca676; --bg-glass:rgba(32,24,16,.85); }
  :root[data-theme="tech"]         { --main-color:#00e0ff; --bg-glass:rgba(10,25,35,.85); }
  :root[data-theme="passion"]      { --main-color:#ff3366; --bg-glass:rgba(35,10,20,.85); }
  :root[data-theme="architecture"] { --main-color:#6fff8d; --bg-glass:rgba(15,25,15,.85); }

  /* Tema por defecto (amber) */
  :root { --main-color:#ffaa00; --bg-glass:rgba(20,20,25,.85);
          --border-glass:rgba(255,170,0,.3); --text-glow:0 0 8px rgba(255,170,0,.4); }

  *{box-sizing:border-box;user-select:none;font-family:'Segoe UI',system-ui,sans-serif;}
  body{margin:0;overflow:hidden;background:transparent;color:#eee;}

  /* WebGL */
  #c{position:fixed;inset:0;width:100%;height:100%;touch-action:none;z-index:0;}
  /* CSS-3D */
  #css3d{position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:1;}
  #css3d.interactive{pointer-events:auto;}

  /* Glass panel */
  .ui-panel{
    position:fixed;left:20px;top:20px;width:380px;max-height:95vh;
    background:var(--bg-glass);backdrop-filter:blur(30px)saturate(150%);
    -webkit-backdrop-filter:blur(30px)saturate(150%);
    border:1px solid var(--border-glass);border-radius:24px;padding:20px;overflow-y:auto;z-index:100;
    box-shadow:0 20px 60px rgba(0,0,0,.6);scrollbar-width:thin;
    scrollbar-color:var(--main-color)transparent;transition:transform .3s cubic-bezier(.4,0,.2,1);
  }
  .ui-panel.minimized{transform:translateX(-460px);}

  h2{margin:0 0 18px;font-size:15px;color:var(--main-color);font-weight:900;
     text-transform:uppercase;letter-spacing:2px;border-bottom:2px solid var(--border-glass);
     padding-bottom:12px;display:flex;justify-content:space-between;align-items:center;
     text-shadow:var(--text-glow);}
  .sec-head{font-size:11px;font-weight:900;color:#aaa;margin:18px 0 8px;
            text-transform:uppercase;letter-spacing:1.5px;}

  .row{display:flex;align-items:center;gap:10px;margin-bottom:8px;font-size:12px;}
  label{flex:1;color:#ddd;cursor:pointer;white-space:nowrap;font-weight:600;}

  input[type=range]{flex:2;height:4px;accent-color:var(--main-color);
       background:rgba(255,255,255,.1);border-radius:2px;appearance:none;}
  input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none;width:14px;height:14px;background:var(--main-color);
      border-radius:50%;box-shadow:var(--text-glow);}
  input[type=checkbox]{width:16px;height:16px;accent-color:var(--main-color);cursor:pointer;}
  .val{width:64px;text-align:right;font-size:11px;color:var(--main-color);
       font-family:'Fira Code',monospace;font-weight:800;}

  select,input[type=url],input[type=text],input[type=number]{
    width:100%;background:rgba(0,0,0,.3);border:1px solid var(--border-glass);color:#fff;
    padding:8px 12px;border-radius:10px;outline:none;transition:.3s;
  }

  button{flex:1;padding:10px;border-radius:10px;border:none;font-weight:900;cursor:pointer;
         color:#000;background:var(--main-color);transition:.25s;font-size:11px;
         text-transform:uppercase;box-shadow:var(--text-glow);}
  button:active{transform:scale(.97);}
  button.danger{background:#ff3333;color:#fff;box-shadow:0 0 8px rgba(255,51,51,.6);}
  button.drive{background:#00C853;color:#fff;box-shadow:0 0 8px rgba(0,200,83,.6);}
  button.secondary{background:rgba(255,255,255,.1);color:#fff;border:1px solid var(--border-glass);box-shadow:none;}
  button.small{padding:8px;font-size:10px;letter-spacing:1px;}

  #toggleUI{position:fixed;left:20px;top:20px;z-index:101;width:44px;height:44px;border-radius:50%;
            background:var(--bg-glass);backdrop-filter:blur(20px);border:2px solid var(--main-color);
            color:var(--main-color);font-weight:900;cursor:pointer;display:none;font-size:20px;
            align-items:center;justify-content:center;box-shadow:var(--text-glow);}

  #vrBtn{position:fixed;bottom:40px;left:50%;transform:translateX(-50%);
         padding:16px 50px;background:var(--main-color);color:#000;border-radius:50px;
         font-weight:1000;z-index:1000;display:none;box-shadow:0 0 30px rgba(255,170,0,.7);
         border:3px solid #fff;font-size:14px;letter-spacing:2px;}

  .loader{position:fixed;inset:0;background:#000;z-index:5000;display:none;
          place-items:center;color:var(--main-color);font-weight:1000;letter-spacing:4px;font-size:22px;
          text-shadow:var(--text-glow);}

  /* ‚Ä¶ el resto de estilos permanece igual ‚Ä¶ */
  </style>
</head>
<body>
  <canvas id="c"></canvas>
  <div id="css3d"></div>
  <div class="loader" id="loader">CARGANDO‚Ä¶</div>
  <button id="toggleUI" onclick="toggleUIPanel()">‚ò∞</button>

  <div class="ui-panel" id="ui">
    <h2><span>DIAMOND v24.x FUSION</span>
        <span style="cursor:pointer;font-size:18px;" onclick="toggleUIPanel()">√ó</span></h2>

    <!-- Paleta de color -->
    <div class="sec-head">üé® Tema</div>
    <div class="row">
      <select id="themeSel"
              onchange="document.documentElement.dataset.theme=this.value">
        <option value="amber" selected>√Åmbar</option>
        <option value="earth">Tierra</option>
        <option value="tech">Tech</option>
        <option value="passion">Passion</option>
        <option value="architecture">Architecture</option>
      </select>
    </div>

    <!-- Arquitectura -->
    <div class="sec-head">üìê Arquitectura</div>
    <div class="row">
      <select id="unitSystem" onchange="updateUnits()">
        <option value="m">Metros (m)</option>
        <option value="cm">Cent√≠metros (cm)</option>
        <option value="ft">Pies (ft)</option>
      </select>
    </div>
    <div class="row"><label><input type="checkbox" id="showDims" checked> Cotas Din√°micas</label></div>
    <div class="row"><label><input type="checkbox" id="showCoords" checked> Coordenadas X/Y/Z</label></div>
    <div class="row"><label><input type="checkbox" id="showGrid" checked onchange="updateGrid()"> Suelo Hologr√°fico</label></div>

    <!-- ‚òÅÔ∏è Proyecto -->
    <div class="sec-head">‚òÅÔ∏è Proyecto</div>
    <div class="row" id="authPanel"><button onclick="handleAuthClick()" class="drive">Conectar Drive</button></div>
    <div class="row" id="driveActions" style="display:none;gap:8px;">
      <button onclick="saveSceneToDrive()" class="secondary">Guardar en Drive</button>
      <button onclick="loadSceneFromDrive()" class="secondary">Cargar</button>
    </div>
    <div class="row" style="gap:8px;">
      <button onclick="saveToLocal()"  class="secondary">Exportar JSON</button>
      <input  type="file" id="jsonImport" accept=".json" style="display:none">
      <button onclick="document.getElementById('jsonImport').click()" class="secondary">Importar</button>
    </div>
        <!-- IMPORTAR & YOUTUBE se quedan sin cambios hasta abajo del panel -->
    <!-- ‚Ä¶ (pega aqu√≠ todo tu HTML del panel original tal cual) ‚Ä¶ -->

    <div class="sec-head">‚öôÔ∏è Realidad Mixta</div>
    <div class="row"><label><input type="checkbox" id="checkOcclusion"> Oclusi√≥n Depth API</label></div>
  </div>

  <button id="vrBtn">INICIAR MR</button>

  <!-- Import map 3D libs -->
  <script type="importmap">
  { "imports": {
      "three":           "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
      "three/addons/":   "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
  } }
  </script>
    <script type="module">
  import * as THREE from 'three';
  import { OrbitControls        } from 'three/addons/controls/OrbitControls.js';
  import { TransformControls    } from 'three/addons/controls/TransformControls.js';
  import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';
  import { GLTFLoader           } from 'three/addons/loaders/GLTFLoader.js';
  import { FBXLoader            } from 'three/addons/loaders/FBXLoader.js';
  import { OBJLoader            } from 'three/addons/loaders/OBJLoader.js';
  import { MTLLoader            } from 'three/addons/loaders/MTLLoader.js';
  import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

  /* ==========================================================
       0 ¬∑ Worker para GIF - decodificaci√≥n off-thread
  ========================================================== */
  const gifWorker = new Worker(URL.createObjectURL(new Blob([`
     importScripts('https://cdn.jsdelivr.net/npm/omggif@1.0.10/omggif.js');
     onmessage=({data})=>{
        const r=new Omggif.GifReader(new Uint8Array(data.buf));
        const frames=[];
        for(let f=0;f<r.numFrames();f++){
          const dat=new Uint8Array(r.width*r.height*4);
          r.decodeAndBlitFrameRGBA(f,dat);
          frames.push({dat,delay:r.frameInfo(f).delay*10});
        }
        postMessage({w:r.width,h:r.height,frames},frames.map(x=>x.dat.buffer));
     };
  `],{type:'text/javascript'})));

  /* ‚Äî‚Äî el resto de constantes (CLIENT_ID, helpers, shaders‚Ä¶) permanece igual, salvo los cambios que se indican ‚Äî‚Äî */

  /* ==========================================================
       1 ¬∑  Proyecciones ‚Äî YouTube siempre plano
  ========================================================== */
  function applyProjection(layer, mode){
    /* YouTube bloquea proyecciones curvas / 360 */
    if(layer.kind==='youtube'){
      layer.projection='plane';
      if(activeId===layer.id){
        const sel=document.getElementById('projSelect');
        sel.value='plane'; sel.disabled=true;       // üîí bloquea selector
      }
      return;
    }else if(activeId===layer.id){
      document.getElementById('projSelect').disabled=false;
    }

    layer.projection=mode;
    /* ... resto del algoritmo original sin cambios ... */
  }

  /* ==========================================================
       2 ¬∑  Transform sliders ‚ñ∫ tiempo real
  ========================================================== */
  document.querySelectorAll('input[type=range]').forEach(i=>{
    i.addEventListener('input',e=>{
      const id=e.target.id; const val=parseFloat(e.target.value);
      const lbl=document.getElementById('v_'+id);
      if(lbl) lbl.textContent=Number.isFinite(val)?val.toFixed(3):'0';
      updateActiveParam(id,val);

      /*  ‚¨áÔ∏é aplicamos en vivo */
      if(id.startsWith('tPos')||id.startsWith('tRot')||id==='tScale'){
        applyTransformFromUI();
      }

      if(id==='vidVol')  onVideoVolume(val);
      if(id==='vidSeek') onVideoSeek(val);
    });
  });

  /* ==========================================================
       3 ¬∑  Serializado / carga local  (.json)
  ========================================================== */
  function sceneToJSON(){
    return JSON.stringify(objects.map(o=>({
      id:o.id,name:o.name,kind:o.kind,projection:o.projection,sourceUrl:o.sourceUrl,
      billboard:o.billboard,visible:o.visible,locked:o.locked,
      pos:o.root3D.position.toArray(),
      rot:o.root3D.rotation.toArray(),
      scl:o.root3D.scale.toArray()
    })));
  }
  async function saveToLocal(){
    const blob=new Blob([sceneToJSON()],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='diamond_scene.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),2000);
  }
  async function loadFromJSON(file){
    const cfgs=JSON.parse(await file.text());
    [...objects].forEach(()=>deleteActive());           // limpia escena actual
    for(const cfg of cfgs){
      let layer=null;
      if(cfg.kind==='model'&&cfg.sourceUrl.match(/\.(glb|gltf)$/i))
        layer=await addModel(cfg.sourceUrl,cfg.name,true);
      else if(cfg.kind==='video')  layer=await addMedia(cfg.sourceUrl,'video',cfg.name,true);
      else if(cfg.kind==='gif')    layer=await addMedia(cfg.sourceUrl,'gif',cfg.name,true);
      else if(cfg.kind==='image')  layer=await addMedia(cfg.sourceUrl,'image',cfg.name,true);
      else if(cfg.kind==='youtube'){ document.getElementById('ytUrl').value=cfg.sourceUrl; await addYouTube(); layer=objects.at(-1);}
      if(!layer) continue;
      layer.root3D.position.fromArray(cfg.pos);
      layer.root3D.rotation.fromArray(cfg.rot);
      layer.root3D.scale.fromArray(cfg.scl);
      layer.billboard=cfg.billboard;
      setLayerVisible(layer,cfg.visible);
      layer.locked=cfg.locked;
      applyProjection(layer,cfg.projection);
    }
    updateLayers();
  }
  document.getElementById('jsonImport').addEventListener('change',e=>{
    if(e.target.files[0]) loadFromJSON(e.target.files[0]);
    e.target.value='';
  });

  /* ==========================================================
       4 ¬∑  GIF  ‚Äî decodificaci√≥n con worker
  ========================================================== */
  async function decodeGif(arrayBuffer){
    return await new Promise(res=>{
      gifWorker.onmessage=e=>res(e.data);
      gifWorker.postMessage({buf:arrayBuffer},[arrayBuffer]);
    });
  }

  /* ‚ñ∫  addGifFromFile ‚Äî sustituye cuerpo por versi√≥n worker */
  async function addGifFromFile(file){
    toggleLoader(true,'CARGANDO GIF‚Ä¶');
    try{
      const buf=await file.arrayBuffer();
      const {w,h,frames}=await decodeGif(buf);

      const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h;
      const ctx=cvs.getContext('2d');
      const dat=ctx.createImageData(w,h);
      const tex=new THREE.CanvasTexture(cvs); tex.colorSpace=THREE.SRGBColorSpace;

      const gifData={frames,idx:0,next:0,ctx,dat,tex,playing:true};
      const aspect=w/Math.max(1,h);

      /* ‚Ä¶ el resto del c√≥digo original de addGifFromFile creando la capa
         (root3D, material, etc.) pero usando gifData anterior ‚Ä¶ */
    }catch(e){ console.error(e); alert('Error GIF'); }
    finally{ toggleLoader(false); }
  }

  /* ‚ñ∫  loop de render: nueva lectura de fotogramas */
  if(o.kind==='gif'&&o.gifData?.playing){
    const g=o.gifData;
    if(performance.now()>g.next){
      const fr=g.frames[g.idx];
      g.dat.data.set(fr.dat);
      g.ctx.putImageData(g.dat,0,0); g.tex.needsUpdate=true;
      g.next=performance.now()+fr.delay;
      g.idx=(g.idx+1)%g.frames.length;
    }
  }

  /* ==========================================================
       5 ¬∑  Depth shader ‚Äî fix Meta Quest
  ========================================================== */
  const depthFS = `#version 300 es
    precision highp float; precision highp sampler2D;
    in vec2 vUv;
    uniform sampler2D uDepth;
    uniform float uRawToMeters;
    uniform mat4 uProj;
    out vec4 outColor;
    float decode(in vec2 la){ return la.x*256.0+la.y; }
    void main(){
      float zMeters = decode(texture(uDepth,vUv).ra) * uRawToMeters;
      if(zMeters<=0.0) discard;
      float z = -zMeters;
      float clipZ = uProj[2][2]*z + uProj[3][2];
      float clipW = uProj[2][3]*z + uProj[3][3];
      gl_FragDepth = clamp((clipZ/clipW)*0.5+0.5,0.0,1.0);
      outColor=vec4(0.0);
    }
  `;
  /*  y cuando creas depthTex:  */
  depthTex = gl.createTexture();
  gl.bindTexture(gl.TEXTURE_2D,depthTex);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);

  /* ==========================================================
       6 ¬∑  JSZip + Drive upload
  ========================================================== */
  window.saveSceneToDrive = async ()=>{
    toggleLoader(true,'COMPRIMIENDO‚Ä¶');
    const zip=new JSZip();
    zip.file('scene.json',sceneToJSON());
    const blobLocal=objects.filter(o=>o.sourceUrl.startsWith('blob:'));
    for(const o of blobLocal){
      const resp=await fetch(o.sourceUrl);
      zip.file('assets/'+o.name,await resp.arrayBuffer());
    }
    const zipBlob=await zip.generateAsync({type:'blob'});

    const meta={name:`diamond_${Date.now()}.zip`,mimeType:'application/zip'};
    const tok=gapi.auth.getToken().access_token;
    const form=new FormData();
    form.append('metadata',new Blob([JSON.stringify(meta)],{type:'application/json'}));
    form.append('file',zipBlob);
    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{
       method:'POST',headers:{Authorization:`Bearer ${tok}`},body:form});
    toggleLoader(false); alert('Escena subida a Drive ‚úÖ');
  };

  /* ==========================================================
       7 ¬∑  El resto del c√≥digo (loaders, XR, controles‚Ä¶)
           permanece sin cambios y se engancha debajo
  ========================================================== */

  /* ‚Ä¶ pega aqu√≠ todo el c√≥digo original restante
       (init, animate, loaders addModel/addMedia, etc.)
       NO olvides que addMedia para GIF debe llamar decodeGif(...) igual que addGifFromFile ‚Ä¶ */

  </script>
</body>
</html>



    <!-- ‚Ä¶ el resto del panel permanece igual (importador, capas, editor, etc.) ‚Ä¶ -->
