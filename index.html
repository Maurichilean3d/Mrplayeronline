<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>MR Studio Diamond v9.0 | Photo Engine</title>
  
  <script src="https://unpkg.com/omggif@1.0.10/omggif.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    * { box-sizing: border-box; user-select: none; }
    body { margin: 0; overflow: hidden; background: transparent; font-family: 'Segoe UI', system-ui, sans-serif; color: #eee; }
    #c { position: fixed; inset: 0; width: 100%; height: 100%; touch-action: none; z-index: 0; }
    
    .ui-panel { 
      position: fixed; left: 20px; top: 20px; width: 400px; max-height: 90vh; 
      background: rgba(12, 12, 16, 0.95); backdrop-filter: blur(20px); 
      border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; 
      padding: 15px; overflow-y: auto; z-index: 100; 
      box-shadow: 0 20px 50px rgba(0,0,0,0.9);
      scrollbar-width: thin; scrollbar-color: #444 #111;
    }
    .ui-panel.minimized { transform: translateX(-450px); }
    
    #toggleUI {
        position: fixed; left: 20px; top: 20px; z-index: 101;
        width: 40px; height: 40px; border-radius: 50%; background: #6c5ce7;
        border: none; color: white; cursor: pointer; display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5); font-weight: bold;
    }

    h2 { margin: 0 0 15px 0; font-size: 18px; color: #a29bfe; font-weight: 800; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;}
    .sec-head { font-size: 10px; font-weight: 800; color: #74b9ff; margin: 15px 0 8px 0; text-transform: uppercase; letter-spacing: 1px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px; }
    
    .row { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
    label { font-size: 10px; flex: 1; color: #bbb; }
    input[type=range] { flex: 2; height: 4px; accent-color: #6c5ce7; cursor: pointer; background: #333; border-radius: 2px; }
    input[type=checkbox] { width: 14px; height: 14px; accent-color: #6c5ce7; cursor: pointer; }
    .val { width: 35px; text-align: right; font-size: 9px; color: #a29bfe; font-family: monospace; }
    
    select, input[type=url] { width: 100%; background: #1e1e24; border: 1px solid #333; color: #eee; padding: 6px; border-radius: 6px; font-size: 11px; outline: none; }
    
    button { flex: 1; padding: 8px; border-radius: 6px; border: none; font-size: 10px; font-weight: 700; cursor: pointer; color: white; background: #2d3436; transition: 0.2s; }
    button:active { transform: scale(0.96); }
    button.primary { background: #6c5ce7; }
    button.danger { background: rgba(214, 48, 49, 0.2); color: #ff7675; border: 1px solid #d63031; }
    button.media-btn { background: #0984e3; }
    button.drive-btn { background: #0F9D58; color: white; }
    
    .layer-list { max-height: 100px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 5px; margin-bottom: 10px; border: 1px solid #333; }
    .layer-item { padding: 6px; font-size: 10px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-bottom: 2px; }
    .layer-item.active { background: rgba(108, 92, 231, 0.25); border-left: 3px solid #6c5ce7; }

    #vrBtn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 14px 40px; background: #6c5ce7; color: white; border-radius: 50px; font-weight: 800; z-index: 1000; display: none; box-shadow: 0 0 30px rgba(108,92,231,0.6); border: 2px solid white; }
    .loader { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; place-items: center; color: #a29bfe; font-weight: 900; letter-spacing: 2px; }
    
    #gStatus { font-size: 10px; color: #aaa; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
    .dot.on { background: #0F9D58; box-shadow: 0 0 5px #0F9D58; }
  </style>
</head>
<body>

<canvas id="c"></canvas>
<div class="loader" id="loader">CARGANDO PHOTO ENGINE...</div>
<button id="toggleUI" onclick="toggleUIPanel()">‚ò∞</button>

<div class="ui-panel" id="ui">
  <h2>
      <span>üíé DIAMOND v9.0</span>
      <button style="width:auto; padding:4px 8px; background:transparent; font-size:16px;" onclick="toggleUIPanel()">√ó</button>
  </h2>

  <div id="gStatus"><div class="dot" id="gDot"></div> <span id="gText">Nube Desconectada</span></div>
  <div class="row" id="authPanel"><button onclick="handleAuthClick()" class="drive-btn">üîë CONECTAR DRIVE</button></div>
  <div class="row" id="driveActions" style="display:none; gap:5px;">
      <button onclick="saveSceneToDrive()">üíæ GUARDAR PROYECTO</button>
      <button onclick="loadSceneFromDrive()">üìÇ CARGAR NUBE</button>
  </div>

  <div class="sec-head">üì• Importar Contenido</div>
  <div class="row">
    <input type="url" id="webUrl" placeholder="URL Video/Imagen">
    <button class="primary" onclick="loadFromWeb()" style="width:50px;">ADD</button>
  </div>
  <button onclick="document.getElementById('fileInput').click()" style="width:100%; margin-top:5px;">üìÅ ABRIR LOCAL</button>
  <input type="file" id="fileInput" multiple style="display:none;">

  <div class="sec-head">Capas</div>
  <div id="layerList" class="layer-list"></div>

  <div id="editorUI" style="display:none;">
    
    <div style="background: rgba(255,255,255,0.03); padding:8px; border-radius:8px; margin-bottom:5px;">
        <div class="row" style="margin:0;"><input type="checkbox" id="checkBillboard"><label>BILLBOARD (Mirar C√°mara)</label></div>
        <div class="row"><label>Escala</label><input type="range" id="scale" min="0.1" max="5" step="0.05"><span class="val" id="v_scale">1.0</span></div>
        <div class="row"><label>Pos Y</label><input type="range" id="posY" min="-5" max="5" step="0.1"><span class="val" id="v_posY">1.6</span></div>
        <div class="row"><label>Pos Z</label><input type="range" id="posZ" min="-10" max="5" step="0.1"><span class="val" id="v_posZ">-2.0</span></div>
        <div class="row"><label>Rot Y</label><input type="range" id="rotY" min="-3.14" max="3.14" step="0.1"><span class="val" id="v_rotY">0.0</span></div>
    </div>

    <div class="sec-head">üé® Color & Luz</div>
    <div class="row"><label>Brillo</label><input type="range" id="brightness" min="-1" max="1" step="0.05" value="0"><span class="val" id="v_brightness">0</span></div>
    <div class="row"><label>Contraste</label><input type="range" id="contrast" min="0" max="3" step="0.1" value="1"><span class="val" id="v_contrast">1</span></div>
    <div class="row"><label>Saturaci√≥n</label><input type="range" id="saturation" min="0" max="3" step="0.1" value="1"><span class="val" id="v_saturation">1</span></div>
    <div class="row"><label>Emisi√≥n (Luz)</label><input type="range" id="emissive" min="0" max="2" step="0.1" value="0"><span class="val" id="v_emissive">0</span></div>
    
    <div class="row" style="margin-top:5px;">
       <label style="flex:0.5; color:#f55;">R</label><input type="range" id="uRed" min="0" max="2" step="0.1" value="1">
       <label style="flex:0.5; color:#5f5;">G</label><input type="range" id="uGreen" min="0" max="2" step="0.1" value="1">
       <label style="flex:0.5; color:#55f;">B</label><input type="range" id="uBlue" min="0" max="2" step="0.1" value="1">
    </div>

    <div class="sec-head">üì∏ Efectos de Lente</div>
    <div class="row"><label>Desenfoque (Blur)</label><input type="range" id="blur" min="0" max="0.01" step="0.0001" value="0"><span class="val" id="v_blur">0</span></div>
    <div class="row"><label>Borde Suave (Vignette)</label><input type="range" id="vignette" min="0" max="2" step="0.1" value="0"><span class="val" id="v_vignette">0</span></div>
    <div class="row"><label>Grano (Noise)</label><input type="range" id="noise" min="0" max="0.3" step="0.01" value="0"><span class="val" id="v_noise">0</span></div>
    <div class="row"><label>Opacidad Global</label><input type="range" id="opacity" min="0" max="1" step="0.01" value="1"><span class="val" id="v_opacity">1</span></div>

    <div class="sec-head">üõ†Ô∏è Herramientas</div>
    <select id="projSelect" onchange="updateProjection()" style="margin-bottom:5px;">
      <option value="plane">Plano Standard</option>
      <option value="curved">Pantalla Curva IMAX</option>
      <option value="orb">Esfera Flotante</option>
      <option value="360">Entorno 360¬∞</option>
    </select>
    
    <div class="row"><label><input type="checkbox" id="chromaToggle"> Chroma Key</label> 
    <input type="color" id="pickerColor" value="#00ff00" style="width:30px; border:none; padding:0;"></div>
    <div id="chromaPanel" style="display:none; padding-left:10px; border-left:2px solid #333;">
        <div class="row"><label>Rango</label><input type="range" id="k1sim" min="0" max="0.8" step="0.01"></div>
        <div class="row"><label>Suavizado</label><input type="range" id="k1smooth" min="0" max="0.4" step="0.01"></div>
    </div>
    
    <div class="row" style="margin-top:10px; gap:5px;">
        <button id="btnPlay" class="media-btn" onclick="mediaAction('play')">‚ñ∂</button>
        <button id="btnPause" class="media-btn" onclick="mediaAction('pause')">‚è∏</button>
        <button class="danger" onclick="deleteActive()">üóëÔ∏è BORRAR</button>
    </div>
  </div>

  <div class="sec-head">‚öôÔ∏è Config MR</div>
  <div class="row"><label><input type="checkbox" id="checkOcclusion"> Oclusi√≥n (Depth API)</label></div>
</div>

<button id="vrBtn">ENTRAR EN MR</button>

<script type="importmap">
{ "imports": {
  "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
  "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
} }
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { TransformControls } from 'three/addons/controls/TransformControls.js';

// ==========================================
// üîë CONFIGURACI√ìN GOOGLE (RELLENA ESTO)
// ==========================================
const CLIENT_ID = ''; 
const API_KEY = '';     
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

// ==========================================
// üé® PRO SHADER: EL MOTOR GR√ÅFICO NUEVO
// ==========================================
const vShader = `
varying vec2 vUv; 
void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }
`;

const fShader = `
uniform sampler2D map;
uniform float uAspect; // Para calcular blur correcto

// Color Grading
uniform float uBrightness;
uniform float uContrast;
uniform float uSaturation;
uniform vec3 uTint; // RGB
uniform float uEmissive;

// Lens Effects
uniform float uBlur;
uniform float uVignette;
uniform float uNoise;
uniform float uTime; // Para animar ruido

// Standard
uniform float uOpacity;
uniform bool chromaOn;
uniform vec3 k1; 
uniform float sim1; 
uniform float smooth1;

varying vec2 vUv;

// Funci√≥n de Ruido simple
float random(vec2 st) {
    return fract(sin(dot(st.xy, vec2(12.9898,78.233))) * 43758.5453123);
}

void main() {
  vec4 texColor = vec4(0.0);
  
  // 1. BLUR (5-Tap Gaussian simplificado)
  if (uBlur > 0.0) {
      float off = uBlur * 0.05;
      texColor += texture2D(map, vUv) * 0.3;
      texColor += texture2D(map, vUv + vec2(off, 0.0)) * 0.175;
      texColor += texture2D(map, vUv - vec2(off, 0.0)) * 0.175;
      texColor += texture2D(map, vUv + vec2(0.0, off * uAspect)) * 0.175;
      texColor += texture2D(map, vUv - vec2(0.0, off * uAspect)) * 0.175;
  } else {
      texColor = texture2D(map, vUv);
  }

  // 2. CHROMA KEY
  float alpha = texColor.a;
  if(chromaOn) {
    float d = distance(texColor.rgb, k1);
    float k = smoothstep(sim1, sim1 + smooth1, d);
    alpha *= k;
  }

  // 3. COLOR GRADING CHAIN
  vec3 col = texColor.rgb;
  
  // RGB Tint
  col *= uTint;
  
  // Brillo
  col += uBrightness;
  
  // Contraste
  col = (col - 0.5) * uContrast + 0.5;
  
  // Saturaci√≥n
  float gray = dot(col, vec3(0.299, 0.587, 0.114));
  col = mix(vec3(gray), col, uSaturation);
  
  // Emisi√≥n (Suma de luz)
  col += vec3(uEmissive * 0.5);

  // 4. LENS EFFECTS
  
  // Noise / Film Grain
  if (uNoise > 0.0) {
     float grain = random(vUv + mod(uTime, 10.0));
     col += (grain - 0.5) * uNoise;
  }

  // Vignette (Borde Suave)
  if (uVignette > 0.0) {
     vec2 dist = (vUv - 0.5) * vec2(1.0, 1.0/uAspect); // Corregir por aspecto
     float len = dot(dist, dist) * uVignette * 4.0;
     col *= (1.0 - smoothstep(0.2, 1.0, len));
     // Reducir alpha en bordes extremos para que desaparezca suave
     alpha *= (1.0 - smoothstep(0.5, 1.0, len)); 
  }

  alpha *= uOpacity;

  gl_FragColor = vec4(col, alpha);
  if(alpha < 0.01) discard; 
}
`;

// ==========================================
// ‚öôÔ∏è SISTEMA PRINCIPAL
// ==========================================
let scene, camera, renderer, orbit, transformCtrl, xrSession, xrRefSpace;
let objects = [], activeId = null;
let clock = new THREE.Clock();

function init() {
  scene = new THREE.Scene();
  scene.add(new THREE.AmbientLight(0xffffff, 1));

  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 500);
  camera.position.set(0, 1.6, 2);

  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('c'), antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.xr.enabled = true;

  orbit = new OrbitControls(camera, renderer.domElement);
  orbit.target.set(0, 1.6, -2);
  orbit.enableDamping = true;

  transformCtrl = new TransformControls(camera, renderer.domElement);
  transformCtrl.addEventListener('dragging-changed', e => orbit.enabled = !e.value);
  scene.add(transformCtrl);
  
  setupVR();
  renderer.setAnimationLoop(animate);
  
  // UI Listeners
  document.getElementById('pickerColor').addEventListener('input', updateMaterial);
  document.getElementById('chromaToggle').addEventListener('change', updateMaterial);
  document.getElementById('checkBillboard').addEventListener('change', (e) => {
      const o = objects.find(obj => obj.id === activeId);
      if(o) { o.billboard = e.target.checked; if(!o.billboard) o.mesh.rotation.set(0,0,0); }
  });
  
  // Bind all sliders generically
  document.querySelectorAll('input[type=range]').forEach(input => {
      input.addEventListener('input', (e) => {
         const val = parseFloat(e.target.value);
         document.getElementById('v_' + e.target.id).innerText = val.toFixed(2);
         updateMaterialParam(e.target.id, val);
      });
  });
}

// ==========================================
// üì¶ ASSET LOADER MEJORADO
// ==========================================
async function addAsset(url, type, name, isGif = false, isRestore = false) {
  if(!isRestore) toggleLoader(true);
  let tex, mesh, gifData = null, video = null;
  let newObj = null;

  try {
    if (isGif) {
      const resp = await fetch(url);
      const buf = await resp.arrayBuffer();
      const reader = new window.Omggif.GifReader(new Uint8Array(buf));
      const cvs = document.createElement('canvas');
      cvs.width = reader.width; cvs.height = reader.height;
      const ctx = cvs.getContext('2d');
      const imgData = ctx.createImageData(cvs.width, cvs.height);
      tex = new THREE.CanvasTexture(cvs);
      tex.colorSpace = THREE.SRGBColorSpace;
      gifData = { reader, ctx, imgData, tex, frame: 0, nextTime: 0, playing: true };
    } else if (type === 'video') {
      video = document.createElement('video');
      video.src = url;
      video.loop = true; video.muted = true; video.crossOrigin = "anonymous";
      video.playsInline = true;
      await video.play();
      tex = new THREE.VideoTexture(video);
      tex.colorSpace = THREE.SRGBColorSpace;
    } else {
      tex = await new THREE.TextureLoader().loadAsync(url);
      tex.colorSpace = THREE.SRGBColorSpace;
    }

    const aspect = video ? video.videoWidth/video.videoHeight : (tex.image ? tex.image.width/tex.image.height : 1.77);

    // NUEVO MATERIAL CON UNIFORMS EXTENDIDOS
    const mat = new THREE.ShaderMaterial({
      uniforms: { 
        map: { value: tex }, 
        uAspect: { value: aspect },
        uTime: { value: 0 },
        // Grading
        uBrightness: { value: 0.0 },
        uContrast: { value: 1.0 },
        uSaturation: { value: 1.0 },
        uTint: { value: new THREE.Vector3(1,1,1) },
        uEmissive: { value: 0.0 },
        uOpacity: { value: 1.0 },
        // Effects
        uBlur: { value: 0.0 },
        uVignette: { value: 0.0 },
        uNoise: { value: 0.0 },
        // Chroma
        chromaOn: { value: false }, 
        k1: { value: new THREE.Color(0,1,0) }, 
        sim1: { value: 0.4 }, 
        smooth1: { value: 0.08 }
      },
      vertexShader: vShader, 
      fragmentShader: fShader, 
      transparent: true, 
      side: THREE.DoubleSide,
      depthWrite: false
    });

    const geometry = new THREE.PlaneGeometry(aspect * 2, 2); 
    mesh = new THREE.Mesh(geometry, mat);
    mesh.position.set(0, 1.6, -2);
    
    newObj = { 
        id: Math.random().toString(36).substr(2,9), 
        name, mesh, video, gifData, type, 
        billboard: false,
        originalAspect: aspect,
        sourceUrl: url 
    };
    
    objects.push(newObj);
    scene.add(mesh);
    if(!isRestore) selectObject(newObj.id);
  } catch (e) { 
    console.error(e); 
    if(!isRestore) alert("Error cargando. Revisa CORS.");
  }
  if(!isRestore) toggleLoader(false);
  return newObj;
}

// ==========================================
// üéÆ UPDATE LOOP & LOGIC
// ==========================================
function animate(time) {
  const dt = clock.getDelta();
  const elapsedTime = clock.getElapsedTime();
  orbit.update();
  
  objects.forEach(obj => {
      // Billboard
      if(obj.billboard && obj.mesh) {
          obj.mesh.lookAt(camera.position.x, obj.mesh.position.y, camera.position.z);
      }
      
      // Update Time Uniform for Noise
      if(obj.mesh && obj.mesh.material.uniforms.uTime) {
          obj.mesh.material.uniforms.uTime.value = elapsedTime;
      }
      
      // GIF Update
      if (obj.gifData && obj.gifData.playing) {
        const g = obj.gifData;
        if (performance.now() > g.nextTime) {
          g.reader.decodeAndBlitFrameRGBA(g.frame, g.imgData.data);
          g.ctx.putImageData(g.imgData, 0, 0);
          g.tex.needsUpdate = true;
          g.nextTime = performance.now() + (g.reader.frameInfo(g.frame).delay * 10 || 100);
          g.frame = (g.frame + 1) % g.reader.numFrames();
        }
      }
  });

  renderer.render(scene, camera);
}

function updateMaterialParam(id, val) {
    const obj = objects.find(o => o.id === activeId);
    if(!obj) return;
    const u = obj.mesh.material.uniforms;

    // Mapeo de IDs de Inputs a Uniforms
    if(id === 'scale') obj.mesh.scale.setScalar(val);
    else if(id === 'posY') obj.mesh.position.y = val;
    else if(id === 'posZ') obj.mesh.position.z = val;
    else if(id === 'rotY') obj.mesh.rotation.y = val;
    
    else if(id === 'brightness') u.uBrightness.value = val;
    else if(id === 'contrast') u.uContrast.value = val;
    else if(id === 'saturation') u.uSaturation.value = val;
    else if(id === 'emissive') u.uEmissive.value = val;
    else if(id === 'opacity') u.uOpacity.value = val;
    
    else if(id === 'blur') u.uBlur.value = val;
    else if(id === 'vignette') u.uVignette.value = val;
    else if(id === 'noise') u.uNoise.value = val;
    
    else if(id === 'k1sim') u.sim1.value = val;
    else if(id === 'k1smooth') u.smooth1.value = val;

    // RGB Tint (Vector3)
    if(id === 'uRed' || id === 'uGreen' || id === 'uBlue') {
        u.uTint.value.set(
            document.getElementById('uRed').value,
            document.getElementById('uGreen').value,
            document.getElementById('uBlue').value
        );
    }
}

function updateMaterial() {
    const obj = objects.find(o => o.id === activeId);
    if(!obj) return;
    const u = obj.mesh.material.uniforms;
    
    u.chromaOn.value = document.getElementById('chromaToggle').checked;
    document.getElementById('chromaPanel').style.display = u.chromaOn.value ? 'block' : 'none';
    u.k1.value.set(document.getElementById('pickerColor').value);
}

function selectObject(id) {
  activeId = id;
  const obj = objects.find(o => o.id === id);
  if (!obj) return;
  transformCtrl.attach(obj.mesh);
  document.getElementById('editorUI').style.display = 'block';
  updateLayers();

  // SET UI VALUES FROM OBJECT
  const u = obj.mesh.material.uniforms;
  const setVal = (domId, val) => {
      document.getElementById(domId).value = val;
      document.getElementById('v_' + domId).innerText = (typeof val === 'number') ? val.toFixed(2) : val;
  };

  setVal('scale', obj.mesh.scale.x);
  setVal('posY', obj.mesh.position.y);
  setVal('posZ', obj.mesh.position.z);
  setVal('rotY', obj.mesh.rotation.y);

  setVal('brightness', u.uBrightness.value);
  setVal('contrast', u.uContrast.value);
  setVal('saturation', u.uSaturation.value);
  setVal('emissive', u.uEmissive.value);
  setVal('opacity', u.uOpacity.value);
  
  setVal('blur', u.uBlur.value);
  setVal('vignette', u.uVignette.value);
  setVal('noise', u.uNoise.value);
  
  document.getElementById('uRed').value = u.uTint.value.x;
  document.getElementById('uGreen').value = u.uTint.value.y;
  document.getElementById('uBlue').value = u.uTint.value.z;

  document.getElementById('checkBillboard').checked = obj.billboard;
  document.getElementById('chromaToggle').checked = u.chromaOn.value;
  setVal('k1sim', u.sim1.value);
  setVal('k1smooth', u.smooth1.value);
  document.getElementById('chromaPanel').style.display = u.chromaOn.value ? 'block' : 'none';
  document.getElementById('pickerColor').value = '#' + u.k1.value.getHexString();
}

// ==========================================
// ‚òÅÔ∏è PERSISTENCIA MEJORADA
// ==========================================
window.saveSceneToDrive = () => {
    if(objects.length === 0) return;
    toggleLoader(true);
    const sceneData = objects.map(o => ({
        type: o.type, url: o.sourceUrl, name: o.name,
        transform: { pos: o.mesh.position.toArray(), rot: o.mesh.rotation.toArray(), scl: o.mesh.scale.toArray() },
        // GUARDAMOS LOS NUEVOS PAR√ÅMETROS
        settings: {
            billboard: o.billboard,
            opacity: o.mesh.material.uniforms.uOpacity.value,
            brightness: o.mesh.material.uniforms.uBrightness.value,
            contrast: o.mesh.material.uniforms.uContrast.value,
            saturation: o.mesh.material.uniforms.uSaturation.value,
            emissive: o.mesh.material.uniforms.uEmissive.value,
            blur: o.mesh.material.uniforms.uBlur.value,
            vignette: o.mesh.material.uniforms.uVignette.value,
            noise: o.mesh.material.uniforms.uNoise.value,
            tint: o.mesh.material.uniforms.uTint.value.toArray(),
            chromaOn: o.mesh.material.uniforms.chromaOn.value,
            chromaColor: o.mesh.material.uniforms.k1.value.getHexString(),
            sim: o.mesh.material.uniforms.sim1.value,
            smooth: o.mesh.material.uniforms.smooth1.value
        }
    }));
    
    // ... (El c√≥digo de subida es igual que antes, solo cambia el JSON)
    const fileContent = JSON.stringify(sceneData);
    const metadata = { 'name': 'diamond_pro_v9.json', 'mimeType': 'application/json' };
    const multipart = `\r\n--foo\r\nContent-Type: application/json\r\n\r\n${JSON.stringify(metadata)}\r\n--foo\r\nContent-Type: application/json\r\n\r\n${fileContent}\r\n--foo--`;

    gapi.client.request({
      'path': '/upload/drive/v3/files', 'method': 'POST',
      'params': {'uploadType': 'multipart'},
      'headers': { 'Content-Type': 'multipart/related; boundary=foo' },
      'body': multipart
    }).then(() => { toggleLoader(false); alert("Guardado OK"); })
      .catch(e => { toggleLoader(false); console.error(e); alert("Error guardando"); });
};

async function reconstructScene(data) {
    [...objects].forEach(o => { scene.remove(o.mesh); if(o.video) o.video.pause(); });
    objects = []; transformCtrl.detach(); document.getElementById('editorUI').style.display = 'none';

    for (const item of data) {
        if(!item.url) continue;
        const obj = await addAsset(item.url, item.type, item.name, item.url.includes('.gif'), true);
        if (obj) {
            obj.mesh.position.fromArray(item.transform.pos);
            obj.mesh.rotation.fromArray(item.transform.rot);
            obj.mesh.scale.fromArray(item.transform.scl);
            
            // RESTAURAR PARAMETROS PRO
            const u = obj.mesh.material.uniforms;
            const s = item.settings;
            obj.billboard = s.billboard;
            u.uOpacity.value = s.opacity;
            u.uBrightness.value = s.brightness || 0;
            u.uContrast.value = s.contrast || 1;
            u.uSaturation.value = s.saturation || 1;
            u.uEmissive.value = s.emissive || 0;
            u.uBlur.value = s.blur || 0;
            u.uVignette.value = s.vignette || 0;
            u.uNoise.value = s.noise || 0;
            if(s.tint) u.uTint.value.fromArray(s.tint);
            
            u.chromaOn.value = s.chromaOn;
            u.k1.value.set('#' + s.chromaColor);
            u.sim1.value = s.sim;
            u.smooth1.value = s.smooth;
        }
    }
    updateLayers(); toggleLoader(false);
}

// UTILS
window.handleAuthClick = () => {
    if(!CLIENT_ID) { alert("Pon tus API KEYS"); return; }
    gapi.load('client:auth2', () => {
        gapi.client.init({ apiKey: API_KEY, clientId: CLIENT_ID, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"], scope: SCOPES })
        .then(() => gapi.auth2.getAuthInstance().signIn())
        .then(() => {
            document.getElementById('authPanel').style.display = 'none';
            document.getElementById('driveActions').style.display = 'flex';
            document.getElementById('gDot').classList.add('on');
            document.getElementById('gText').innerText = "Conectado";
        });
    });
};
window.loadSceneFromDrive = () => {
    toggleLoader(true);
    gapi.client.drive.files.list({ 'q': "mimeType='application/json' and trashed=false", 'orderBy': 'createdTime desc', 'pageSize': 1 })
    .then(res => res.result.files[0] ? gapi.client.drive.files.get({ fileId: res.result.files[0].id, alt: 'media' }) : Promise.reject("No hay saves"))
    .then(res => reconstructScene(res.result)).catch(e => { toggleLoader(false); alert("Error carga: " + e); });
};
window.loadFromWeb = () => { const u = document.getElementById('webUrl').value; if(u) addAsset(u, u.match(/\.(mp4|webm)/i)?'video':'image', 'Web Asset', u.includes('.gif')); };
document.getElementById('fileInput').onchange = (e) => { for(let f of e.target.files) addAsset(URL.createObjectURL(f), f.type.includes('video')?'video':'image', f.name, f.name.includes('.gif')); };
window.deleteActive = () => { const i = objects.findIndex(o => o.id===activeId); if(i>-1) { scene.remove(objects[i].mesh); objects.splice(i,1); transformCtrl.detach(); document.getElementById('editorUI').style.display='none'; updateLayers(); } };
window.mediaAction = (a) => { const o = objects.find(x=>x.id===activeId); if(o && o.video) { if(a=='play') o.video.play(); if(a=='pause') o.video.pause(); } };
function updateLayers() { const l=document.getElementById('layerList'); l.innerHTML=''; objects.forEach(o => { const d=document.createElement('div'); d.className=`layer-item ${o.id===activeId?'active':''}`; d.innerText=(o.type=='video'?'üé¨ ':'üñºÔ∏è ')+o.name.slice(0,15); d.onclick=()=>selectObject(o.id); l.appendChild(d); }); }
window.toggleUIPanel = () => { document.getElementById('ui').classList.toggle('minimized'); document.getElementById('toggleUI').style.display = document.getElementById('ui').classList.contains('minimized') ? 'block' : 'none'; };
window.updateProjection = () => {
  const o = objects.find(x=>x.id===activeId); if(!o) return;
  const m = document.getElementById('projSelect').value; scene.remove(o.mesh);
  let g; if(m=='360') { g=new THREE.SphereGeometry(100,64,32); o.mesh.material.side=THREE.BackSide; }
  else if(m=='orb') { g=new THREE.SphereGeometry(1.5,64,32); o.mesh.material.side=THREE.FrontSide; }
  else if(m=='curved') { g=new THREE.CylinderGeometry(5,5,2,32,1,true,3.8,1.8); o.mesh.scale.set(-1,1,1); o.mesh.material.side=THREE.DoubleSide; }
  else { g=new THREE.PlaneGeometry(o.originalAspect*2, 2); o.mesh.material.side=THREE.DoubleSide; }
  o.mesh.geometry=g; scene.add(o.mesh); transformCtrl.attach(o.mesh);
};
function toggleLoader(s) { document.getElementById('loader').style.display=s?'grid':'none'; }
function setupVR() { if(navigator.xr) navigator.xr.isSessionSupported('immersive-ar').then(ok=>{ if(ok) { document.getElementById('vrBtn').style.display='block'; document.getElementById('vrBtn').onclick=async()=>{ xrSession=await navigator.xr.requestSession('immersive-ar',{requiredFeatures:['local-floor'],optionalFeatures:['dom-overlay'],domOverlay:{root:document.body}}); renderer.xr.setSession(xrSession); xrRefSpace=await xrSession.requestReferenceSpace('local-floor'); }; } }); }

init();
</script>
</body>
</html>
