<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MR Studio Diamond V24 - FIXED LOCAL</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <style>
        :root {
            --ui-primary: #ffaa00;
            --ui-bg: rgba(15, 15, 20, 0.95);
            --ui-border: rgba(255, 170, 0, 0.4);
        }

        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }

        /* Contenedor Principal con SCROLL */
        #ui-container {
            position: fixed;
            top: 10px;
            left: 10px;
            bottom: 10px;
            width: 320px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            pointer-events: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--ui-primary) transparent;
        }

        .panel {
            background: var(--ui-bg);
            border: 1px solid var(--ui-border);
            border-radius: 12px;
            padding: 15px;
            color: white;
            backdrop-filter: blur(10px);
        }

        .panel-title {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 12px;
            color: var(--ui-primary);
            text-transform: uppercase;
            border-bottom: 1px solid var(--ui-border);
            padding-bottom: 5px;
        }

        .btn {
            background: rgba(255, 170, 0, 0.2);
            border: 1px solid var(--ui-primary);
            padding: 10px;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .btn:hover { background: var(--ui-primary); color: black; }

        input[type="text"], select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background: #111;
            border: 1px solid #444;
            color: white;
            border-radius: 4px;
        }

        .layer-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #333;
            background: #050505;
        }

        .layer-item {
            padding: 8px;
            font-size: 12px;
            border-bottom: 1px solid #222;
            cursor: pointer;
        }

        .layer-item.active { background: var(--ui-primary); color: black; }

        .slider-group { margin: 10px 0; }
        .slider-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px; }
        input[type="range"] { width: 100%; accent-color: var(--ui-primary); }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="ui-container">
        <div class="panel">
            <div class="panel-title">游닌 Cargar Media</div>
            <label style="font-size: 11px; color: #888;">URL Directa:</label>
            <input type="text" id="url-input" placeholder="https://...">
            
            <button class="btn" onclick="document.getElementById('file-input').click()">游늬 Seleccionar Archivo PC</button>
            <input type="file" id="file-input" class="hidden" onchange="processFile(event)">
            
            <label style="font-size: 11px; color: #888;">Proyecci칩n:</label>
            <select id="proj-type">
                <option value="plane">Plano (Video/Foto)</option>
                <option value="sphere">360춿 (Equirectangular)</option>
            </select>
            <button class="btn" style="background: var(--ui-primary); color: black;" onclick="addFromUrl()">A침adir a Escena</button>
        </div>

        <div class="panel">
            <div class="panel-title">游닍 Capas (Layers)</div>
            <div id="layer-list" class="layer-list"></div>
            <button class="btn" style="margin-top:10px; border-color: red; color: red;" onclick="deleteActive()">Eliminar Seleccionado</button>
        </div>

        <div class="panel">
            <div class="panel-title">游댢 Transformar</div>
            <div class="slider-group">
                <div class="slider-label"><span>Altura (Y)</span><span id="v-y">1.6</span></div>
                <input type="range" id="p-y" min="0" max="5" step="0.1" value="1.6" oninput="liveUpdate()">
            </div>
            <div class="slider-group">
                <div class="slider-label"><span>Distancia (Z)</span><span id="v-z">-3</span></div>
                <input type="range" id="p-z" min="-10" max="0" step="0.1" value="-3" oninput="liveUpdate()">
            </div>
            <div class="slider-group">
                <div class="slider-label"><span>Escala</span><span id="v-s">1</span></div>
                <input type="range" id="p-s" min="0.1" max="5" step="0.1" value="1" oninput="liveUpdate()">
            </div>
        </div>
    </div>

    <a-scene renderer="colorManagement: true;" webxr="overlayElement: #ui-container;">
        <a-entity id="grid" geometry="primitive: plane; width: 20; height: 20" 
                  rotation="-90 0 0" 
                  material="src: https://cdn.aframe.io/a-grid/grid.png; repeat: 20 20; transparent: true; opacity: 0.2">
        </a-entity>

        <a-camera position="0 1.6 0"></a-camera>
        <a-sky color="#0a0a0c"></a-sky>
    </a-scene>

    <script>
        let elements = [];
        let activeId = null;
        let lastFileBlob = null;
        let lastFileType = null;

        // 1. PROCESAR ARCHIVO LOCAL (CORREGIDO)
        function processFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Creamos una URL temporal que el navegador S칈 puede leer
            lastFileBlob = URL.createObjectURL(file);
            lastFileType = file.type.split('/')[0]; // "image" o "video" o "application"
            
            // Si es un modelo 3D por extensi칩n
            if(file.name.endsWith('.glb') || file.name.endsWith('.gltf')) lastFileType = 'model';

            document.getElementById('url-input').value = file.name;
            alert("Archivo cargado: " + file.name + ". Haz click en 'A침adir a Escena'.");
        }

        // 2. A칌ADIR A ESCENA
        function addFromUrl() {
            const urlInput = document.getElementById('url-input').value;
            const proj = document.getElementById('proj-type').value;
            const id = "layer_" + Date.now();

            let finalUrl = lastFileBlob || urlInput;
            let type = lastFileType || (urlInput.includes('mp4') ? 'video' : 'image');

            if(!finalUrl) return alert("Pon una URL o sube un archivo");

            const entity = document.createElement('a-entity');
            entity.setAttribute('id', id);
            entity.setAttribute('position', '0 1.6 -3');

            if (type === 'video') {
                const vid = document.createElement('video');
                vid.src = finalUrl;
                vid.autoplay = true;
                vid.loop = true;
                vid.muted = true; // Importante para que auto-reproduzca
                vid.play();
                
                if(proj === 'sphere') {
                    entity.setAttribute('geometry', 'primitive: sphere; radius: 5; segmentsWidth: 64; segmentsHeight: 32');
                    entity.setAttribute('scale', '-1 1 1');
                } else {
                    entity.setAttribute('geometry', 'primitive: plane; width: 4; height: 2.25');
                }
                entity.setAttribute('material', {shader: 'flat', src: vid});
            } 
            else if (type === 'model') {
                entity.setAttribute('gltf-model', finalUrl);
            }
            else {
                if(proj === 'sphere') {
                    entity.setAttribute('geometry', 'primitive: sphere; radius: 5');
                    entity.setAttribute('scale', '-1 1 1');
                } else {
                    entity.setAttribute('geometry', 'primitive: plane; width: 4; height: 2.25');
                }
                entity.setAttribute('material', {shader: 'flat', src: finalUrl, transparent: true});
            }

            document.querySelector('a-scene').appendChild(entity);
            
            elements.push({id, type});
            activeId = id;
            updateUI();
            
            // Limpiar temporales
            lastFileBlob = null;
            lastFileType = null;
        }

        // 3. ACTUALIZAR INTERFAZ Y TRANSFORM
        function liveUpdate() {
            if(!activeId) return;
            const el = document.getElementById(activeId);
            const y = document.getElementById('p-y').value;
            const z = document.getElementById('p-z').value;
            const s = document.getElementById('p-s').value;

            document.getElementById('v-y').innerText = y;
            document.getElementById('v-z').innerText = z;
            document.getElementById('v-s').innerText = s;

            el.setAttribute('position', `0 ${y} ${z}`);
            el.setAttribute('scale', `${s} ${s} ${s}`);
        }

        function updateUI() {
            const list = document.getElementById('layer-list');
            list.innerHTML = "";
            elements.forEach(item => {
                const div = document.createElement('div');
                div.className = "layer-item" + (item.id === activeId ? " active" : "");
                div.innerText = item.id;
                div.onclick = () => { activeId = item.id; updateUI(); };
                list.appendChild(div);
            });
        }

        function deleteActive() {
            if(!activeId) return;
            document.getElementById(activeId).remove();
            elements = elements.filter(e => e.id !== activeId);
            activeId = null;
            updateUI();
        }
    </script>
</body>
</html>
