<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>MR Studio Diamond v25.x | Fusion Projections + 3D + 360</title>

  <script src="https://unpkg.com/omggif@1.0.10/omggif.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    /* =========================================
       ESTILO "AMBER GLASS" (base v24)
    ========================================= */
    :root {
      --main-color: #ffaa00;
      --bg-glass: rgba(20, 20, 25, 0.85);
      --border-glass: rgba(255, 170, 0, 0.3);
      --text-glow: 0 0 8px rgba(255, 170, 0, 0.4);
    }

    * { box-sizing: border-box; user-select: none; font-family: 'Segoe UI', system-ui, sans-serif; }
    body { margin: 0; overflow: hidden; background: transparent; color: #eee; }

    #c { position: fixed; inset: 0; width: 100%; height: 100%; touch-action: none; z-index: 0; }
    #css3d { position: fixed; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
    #css3d.interactive { pointer-events: auto; }

    .ui-panel {
      position: fixed; left: 20px; top: 20px; width: 380px; max-height: 95vh;
      background: var(--bg-glass); backdrop-filter: blur(30px) saturate(150%);
      -webkit-backdrop-filter: blur(30px) saturate(150%);
      border: 1px solid var(--border-glass); border-radius: 24px;
      padding: 20px; overflow-y: auto; z-index: 100;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      scrollbar-width: thin; scrollbar-color: var(--main-color) transparent;
      transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }
    .ui-panel.minimized { transform: translateX(-460px); }

    h2 {
      margin: 0 0 18px 0; font-size: 15px; color: var(--main-color); font-weight: 900;
      text-transform: uppercase; letter-spacing: 2px; border-bottom: 2px solid var(--border-glass);
      padding-bottom: 12px; display: flex; justify-content: space-between; align-items: center;
      text-shadow: var(--text-glow);
    }
    .sec-head { font-size: 11px; font-weight: 900; color: #aaa; margin: 18px 0 8px 0; text-transform: uppercase; letter-spacing: 1.5px; }
    .row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 12px; }
    label { flex: 1; color: #ddd; cursor: pointer; white-space: nowrap; font-weight: 600; }

    input[type=range] { flex: 2; height: 4px; accent-color: var(--main-color); background: rgba(255,255,255,0.1); border-radius: 2px; appearance: none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--main-color); border-radius: 50%; box-shadow: var(--text-glow); }
    input[type=checkbox] { width: 16px; height: 16px; accent-color: var(--main-color); cursor: pointer; }
    .val { width: 64px; text-align: right; font-size: 11px; color: var(--main-color); font-family: 'Fira Code', monospace; font-weight: 800; }

    select, input[type=url], input[type=text], input[type=number] { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border-glass); color: #fff; padding: 8px 12px; border-radius: 10px; outline: none; }

    button { flex: 1; padding: 10px; border-radius: 10px; border: none; font-weight: 900; cursor: pointer; color: #000; background: var(--main-color); transition: 0.25s; font-size: 11px; text-transform: uppercase; box-shadow: var(--text-glow); }
    button:active { transform: scale(0.97); }
    button.danger { background: #ff3333; color: white; }
    button.drive { background: #00C853; color: white; }
    button.secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid var(--border-glass); }

    #toggleUI { position: fixed; left: 20px; top: 20px; z-index: 101; width: 44px; height: 44px; border-radius: 50%; background: var(--bg-glass); border: 2px solid var(--main-color); color: var(--main-color); cursor: pointer; display: none; align-items: center; justify-content: center; }
    #vrBtn { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); padding: 16px 50px; background: var(--main-color); color: #000; border-radius: 50px; font-weight: 1000; z-index: 1000; display: none; border: 3px solid #fff; }

    .loader { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; place-items: center; color: var(--main-color); font-weight: 1000; font-size: 22px; text-shadow: var(--text-glow); }
    .layer-list { max-height: 180px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 8px; margin-bottom: 12px; border: 1px solid var(--border-glass); }
    .layer-item { padding: 8px 10px; font-size: 11px; border-radius: 10px; cursor: pointer; display: grid; grid-template-columns: 18px 1fr auto auto; align-items: center; gap: 8px; margin-bottom: 6px; background: rgba(0,0,0,0.12); border: 1px solid rgba(255,255,255,0.06); }
    .layer-item.active { background: rgba(255, 170, 0, 0.2); border-left: 3px solid var(--main-color); color: #fff; }
    .note { font-size: 11px; line-height: 1.35; color: rgba(255,255,255,0.75); border: 1px dashed rgba(255,170,0,0.35); border-radius: 12px; padding: 10px; background: rgba(0,0,0,0.18); }
    .two { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  </style>
</head>
<body>

  <canvas id="c"></canvas>
  <div id="css3d"></div>

  <div class="loader" id="loader">CARGANDO...</div>
  <button id="toggleUI" onclick="toggleUIPanel()">‚ò∞</button>

  <div class="ui-panel" id="ui">
    <h2>
      <span>DIAMOND v25.x FUSION</span>
      <span style="cursor:pointer; font-size:18px;" onclick="toggleUIPanel()">√ó</span>
    </h2>

    <div class="sec-head">üìê Arquitectura</div>
    <div class="row">
      <select id="unitSystem" onchange="updateUnits()">
        <option value="m">Metros (m)</option>
        <option value="cm">Cent√≠metros (cm)</option>
        <option value="ft">Pies (ft)</option>
      </select>
    </div>
    <div class="row"><label><input type="checkbox" id="showDims" checked> Cotas Din√°micas</label></div>
    <div class="row"><label><input type="checkbox" id="showCoords" checked> Coordenadas X/Y/Z</label></div>
    <div class="row"><label><input type="checkbox" id="showGrid" checked onchange="updateGrid()"> Suelo Hologr√°fico</label></div>

    <div class="sec-head">üì• Importar</div>
    <div class="row">
      <input type="url" id="webUrl" placeholder="URL .mp4/.gif/.glb/etc">
      <button onclick="loadFromWeb()" style="flex:0 0 44px;">+</button>
    </div>
    <button onclick="document.getElementById('fileInput').click()" class="secondary" style="margin-top:8px; width:100%;">üìÅ Abrir local</button>
    <input type="file" id="fileInput" multiple style="display:none;" accept=".png,.jpg,.jpeg,.webp,.gif,.mp4,.webm,.glb,.gltf,.fbx,.obj,.mtl">

    <div class="sec-head">‚ñ∂ YouTube</div>
    <div class="row">
      <input type="text" id="ytUrl" placeholder="URL de YouTube">
      <button onclick="addYouTube()" class="small" style="flex:0 0 70px;">ADD</button>
    </div>
    <div class="row"><label><input type="checkbox" id="css3dInteractive"> Interactuar (click)</label></div>

    <div class="sec-head">Capas</div>
    <div id="layerList" class="layer-list"></div>

    <div id="editorUI" style="display:none;">
      <div class="sec-head">üéõ Transform</div>
      <div class="row"><label>Pos X</label><input type="range" id="tPosX" min="-20" max="20" step="0.01" value="0"><span class="val" id="v_tPosX">0</span></div>
      <div class="row"><label>Pos Y</label><input type="range" id="tPosY" min="0" max="20" step="0.01" value="1.6"><span class="val" id="v_tPosY">1.6</span></div>
      <div class="row"><label>Pos Z</label><input type="range" id="tPosZ" min="-50" max="50" step="0.01" value="-2"><span class="val" id="v_tPosZ">-2</span></div>
      <div class="row"><label>Escala</label><input type="range" id="tScale" min="0.05" max="20" step="0.01" value="1"><span class="val" id="v_tScale">1</span></div>
      <div class="row" style="gap:8px;">
        <button onclick="applyTransformFromUI()" class="secondary">Aplicar</button>
        <button onclick="deleteActive()" class="danger">üóë Eliminar</button>
      </div>
      
      <div class="sec-head">üé® Shader</div>
      <div class="row"><label>Opacidad</label><input type="range" id="opacity" min="0" max="1" step="0.01" value="1"><span class="val" id="v_opacity">1</span></div>
      <div class="row"><label><input type="checkbox" id="chromaToggle"> Chroma Key</label></div>
    </div>
  </div>

  <button id="vrBtn">INICIAR MR</button>

  <script type="importmap">
  { "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
  } }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { TransformControls } from 'three/addons/controls/TransformControls.js';
    import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
    import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
    import { MTLLoader } from 'three/addons/loaders/MTLLoader.js';
    import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

    // ‚úÖ CORRECCI√ìN CLAVE: La librer√≠a omggif inyecta GifReader directamente en window
    function ensureOmggifLoaded() {
      return new Promise((resolve, reject) => {
        if (window.GifReader) return resolve(true);
        const s = document.createElement('script');
        s.src = 'https://unpkg.com/omggif@1.0.10/omggif.js';
        s.onload = () => window.GifReader ? resolve(true) : reject("Error al cargar GifReader");
        s.onerror = () => reject("Error de red cargando omggif");
        document.head.appendChild(s);
      });
    }

    const vShader = `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`;
    const fShader = `
      uniform sampler2D map; uniform float uOpacity; uniform bool chromaOn;
      varying vec2 vUv;
      void main() {
        vec4 tex = texture2D(map, vUv);
        if(chromaOn && tex.g > tex.r && tex.g > tex.b) discard;
        gl_FragColor = vec4(tex.rgb, tex.a * uOpacity);
      }
    `;

    let scene, camera, renderer, orbit, transformCtrl, cssRenderer;
    const objects = [];
    let activeId = null;
    let engGroup, coordLabels = {};
    const gltfLoader = new GLTFLoader();
    const fbxLoader = new FBXLoader();
    const objLoader = new OBJLoader();

    function init() {
      scene = new THREE.Scene();
      scene.add(new THREE.AmbientLight(0xffffff, 1.2));
      camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 1000);
      camera.position.set(0, 1.6, 2);

      renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('c'), antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.xr.enabled = true;

      orbit = new OrbitControls(camera, renderer.domElement);
      transformCtrl = new TransformControls(camera, renderer.domElement);
      transformCtrl.addEventListener('dragging-changed', (e) => orbit.enabled = !e.value);
      scene.add(transformCtrl);

      cssRenderer = new CSS3DRenderer();
      cssRenderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById('css3d').appendChild(cssRenderer.domElement);

      initEngineeringUI();
      updateGrid();
      setupVR();
      bindUI();

      renderer.setAnimationLoop(animate);
      window.addEventListener('resize', onResize);
    }

    function onResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      cssRenderer.setSize(window.innerWidth, window.innerHeight);
    }

    async function addMedia(url, kind, name) {
      toggleLoader(true);
      try {
        let tex, gifData = null, video = null;
        if (kind === 'gif') {
          await ensureOmggifLoaded();
          const resp = await fetch(url);
          const buf = await resp.arrayBuffer();
          // ‚úÖ USO CORRECTO: window.GifReader
          const reader = new window.GifReader(new Uint8Array(buf));
          const cvs = document.createElement('canvas');
          cvs.width = reader.width; cvs.height = reader.height;
          const ctx = cvs.getContext('2d');
          const dat = ctx.createImageData(reader.width, reader.height);
          tex = new THREE.CanvasTexture(cvs);
          gifData = { reader, ctx, dat, tex, f:0, next:0 };
        } else if (kind === 'video') {
          video = document.createElement('video');
          video.src = url; video.crossOrigin = 'anonymous'; video.loop = true; video.muted = true; video.play();
          tex = new THREE.VideoTexture(video);
        } else {
          tex = await new THREE.TextureLoader().loadAsync(url);
        }

        const aspect = (kind === 'gif') ? gifData.reader.width/gifData.reader.height : 1.77;
        const mat = new THREE.ShaderMaterial({
          uniforms: { map: { value: tex }, uOpacity: { value: 1 }, chromaOn: { value: false } },
          vertexShader: vShader, fragmentShader: fShader, transparent: true, side: THREE.DoubleSide
        });

        const mesh = new THREE.Mesh(new THREE.PlaneGeometry(aspect, 1), mat);
        const root = new THREE.Group(); root.position.set(0, 1.6, -2);
        root.add(mesh); scene.add(root);

        const layer = { id: Math.random().toString(36).slice(2,9), name, kind, root3D: root, mesh, mat, gifData, video };
        mesh.userData.layerId = layer.id;
        objects.push(layer);
        selectObject(layer.id);
        updateLayers();
      } catch (e) { console.error(e); alert("Error cargando: " + name); }
      toggleLoader(false);
    }

    async function addGifFromFile(file) {
      toggleLoader(true);
      try {
        await ensureOmggifLoaded();
        const buf = await file.arrayBuffer();
        // ‚úÖ USO CORRECTO: window.GifReader
        const reader = new window.GifReader(new Uint8Array(buf));
        const cvs = document.createElement('canvas');
        cvs.width = reader.width; cvs.height = reader.height;
        const ctx = cvs.getContext('2d');
        const dat = ctx.createImageData(reader.width, reader.height);
        const tex = new THREE.CanvasTexture(cvs);

        const mat = new THREE.ShaderMaterial({
          uniforms: { map: { value: tex }, uOpacity: { value: 1 }, chromaOn: { value: false } },
          vertexShader: vShader, fragmentShader: fShader, transparent: true, side: THREE.DoubleSide
        });

        const mesh = new THREE.Mesh(new THREE.PlaneGeometry(reader.width/reader.height, 1), mat);
        const root = new THREE.Group(); root.position.set(0, 1.6, -2);
        root.add(mesh); scene.add(root);

        const layer = { id: Math.random().toString(36).slice(2,9), name: file.name, kind: 'gif', root3D: root, mesh, mat, gifData: { reader, ctx, dat, tex, f:0, next:0 } };
        mesh.userData.layerId = layer.id;
        objects.push(layer);
        selectObject(layer.id);
        updateLayers();
      } catch(e) { console.error(e); alert("GIF Local fall√≥"); }
      toggleLoader(false);
    }

    function selectObject(id) {
      activeId = id;
      const o = objects.find(x => x.id === id);
      if (!o) return;
      transformCtrl.attach(o.root3D);
      document.getElementById('editorUI').style.display = 'block';
      updateLayers();
    }

    function updateLayers() {
      const list = document.getElementById('layerList');
      list.innerHTML = '';
      objects.forEach(o => {
        const row = document.createElement('div');
        row.className = `layer-item ${o.id === activeId ? 'active' : ''}`;
        row.innerHTML = `<span>${o.kind === 'gif' ? 'üëæ' : 'üñºÔ∏è'}</span> <span>${o.name}</span>`;
        row.onclick = () => selectObject(o.id);
        list.appendChild(row);
      });
    }

    function animate() {
      const now = performance.now();
      objects.forEach(o => {
        if (o.kind === 'gif' && o.gifData && now > o.gifData.next) {
          const g = o.gifData;
          g.reader.decodeAndBlitFrameRGBA(g.f, g.dat.data);
          g.ctx.putImageData(g.dat, 0, 0);
          g.tex.needsUpdate = true;
          g.next = now + (g.reader.frameInfo(g.f).delay * 10 || 100);
          g.f = (g.f + 1) % g.reader.numFrames();
        }
      });
      orbit.update();
      renderer.render(scene, camera);
      cssRenderer.render(scene, camera);
    }

    function bindUI() {
      document.getElementById('fileInput').onchange = (e) => {
        for(let f of e.target.files) {
          if(f.name.toLowerCase().endsWith('.gif')) addGifFromFile(f);
          else addMedia(URL.createObjectURL(f), f.type.includes('video') ? 'video' : 'image', f.name);
        }
      };
      document.querySelectorAll('input[type=range]').forEach(input => {
        input.oninput = (e) => {
          const val = parseFloat(e.target.value);
          if(document.getElementById('v_'+input.id)) document.getElementById('v_'+input.id).textContent = val;
          const o = objects.find(x => x.id === activeId);
          if(!o) return;
          if(input.id === 'opacity') o.mat.uniforms.uOpacity.value = val;
          if(input.id.startsWith('tPos')) {
             if(input.id === 'tPosX') o.root3D.position.x = val;
             if(input.id === 'tPosY') o.root3D.position.y = val;
             if(input.id === 'tPosZ') o.root3D.position.z = val;
          }
          if(input.id === 'tScale') o.root3D.scale.setScalar(val);
        };
      });
      document.getElementById('chromaToggle').onchange = (e) => {
        const o = objects.find(x => x.id === activeId);
        if(o) o.mat.uniforms.chromaOn.value = e.target.checked;
      };
    }

    function deleteActive() {
      const idx = objects.findIndex(x => x.id === activeId);
      if (idx > -1) {
        scene.remove(objects[idx].root3D);
        objects.splice(idx, 1);
        transformCtrl.detach();
        document.getElementById('editorUI').style.display = 'none';
        updateLayers();
      }
    }

    function toggleLoader(on) { document.getElementById('loader').style.display = on ? 'grid' : 'none'; }
    window.toggleUIPanel = () => document.getElementById('ui').classList.toggle('minimized');
    window.loadFromWeb = () => { const url = document.getElementById('webUrl').value; if(url.endsWith('.gif')) addMedia(url, 'gif', 'Web GIF'); else addMedia(url, 'image', 'Web Image'); };

    // Stubs para evitar errores de consola
    function initEngineeringUI() {}
    function updateGrid() {}
    function setupVR() {}
    window.updateUnits = () => {};
    window.applyTransformFromUI = () => {};

    init();
  </script>
</body>
</html>
