<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>MR Studio Diamond v40.0 | Ultima Fusion</title>
  
  <script src="https://unpkg.com/omggif@1.0.10/omggif.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  
  <style>
    :root {
      --main-color: #ffaa00; /* √Åmbar Diamond */
      --bg-glass: rgba(15, 15, 20, 0.9);
      --border-glass: rgba(255, 170, 0, 0.4);
      --text-glow: 0 0 10px rgba(255, 170, 0, 0.5);
    }

    * { box-sizing: border-box; user-select: none; font-family: 'Segoe UI', system-ui, sans-serif; }
    body { margin: 0; overflow: hidden; background: #000; color: #eee; }
    #c { position: fixed; inset: 0; width: 100%; height: 100%; touch-action: none; z-index: 0; }
    #css3d { position: fixed; inset: 0; pointer-events: none; z-index: 1; }

    /* UI Estilo √Åmbar Cristal */
    .ui-panel {
      position: fixed; left: 20px; top: 20px; width: 400px; max-height: 95vh;
      background: var(--bg-glass); backdrop-filter: blur(25px);
      border: 1px solid var(--border-glass); border-radius: 24px;
      padding: 22px; overflow-y: auto; z-index: 100;
      box-shadow: 0 25px 60px rgba(0,0,0,0.8);
      scrollbar-width: thin; scrollbar-color: var(--main-color) transparent;
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .ui-panel.minimized { transform: translateX(-450px); }

    h2 { 
      margin: 0 0 15px; font-size: 16px; color: var(--main-color); 
      text-transform: uppercase; letter-spacing: 2px; border-bottom: 2px solid var(--border-glass);
      padding-bottom: 10px; display: flex; justify-content: space-between;
    }

    .sec-head { font-size: 11px; font-weight: 900; color: #888; margin: 15px 0 8px; text-transform: uppercase; }
    .row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 12px; }
    
    input[type=range] { flex: 2; accent-color: var(--main-color); cursor: pointer; }
    .val { width: 50px; text-align: right; color: var(--main-color); font-family: monospace; }
    
    button { 
      flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 800;
      background: var(--main-color); color: #000; cursor: pointer; transition: 0.2s;
    }
    button.secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid var(--border-glass); }
    button.danger { background: #ff4444; color: white; }

    /* Elementos Flotantes */
    #modeBadge {
      position: fixed; top: 20px; right: 20px; padding: 12px 18px;
      background: rgba(0,0,0,0.7); border: 1px solid var(--border-glass);
      border-radius: 15px; display: flex; align-items: center; gap: 10px; z-index: 1000;
    }
    .dot { width: 12px; height: 12px; border-radius: 50%; background: #55efc4; box-shadow: 0 0 10px #55efc4; }

    #vrBtn {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      padding: 18px 60px; background: linear-gradient(135deg, #ffaa00, #ff7700);
      color: white; border-radius: 50px; font-weight: 900; border: 2px solid white;
      box-shadow: 0 0 30px rgba(255, 170, 0, 0.6); display: none; z-index: 2000;
    }

    .layer-list { max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 8px; }
    .layer-item { padding: 10px; margin-bottom: 5px; border-radius: 8px; background: rgba(255,255,255,0.05); cursor: pointer; }
    .layer-item.active { background: rgba(255, 170, 0, 0.2); border: 1px solid var(--main-color); }
  </style>
</head>
<body>
  <canvas id="c"></canvas>
  <div id="css3d"></div>

  <div id="modeBadge">
    <div class="dot" id="modeDot"></div>
    <div id="modeText" style="font-weight: 800; font-size: 13px;">MODO EDITOR</div>
  </div>

  <div class="ui-panel" id="ui">
    <h2><span>DIAMOND v40.0</span> <span onclick="toggleUI()" style="cursor:pointer">√ó</span></h2>
    
    <div class="sec-head">‚òÅÔ∏è Proyecto Nube / Local</div>
    <div class="row">
      <button onclick="saveProject()" class="secondary">üíæ Guardar</button>
      <button onclick="loadProject()" class="secondary">üìÇ Cargar</button>
    </div>
    <button onclick="connectDrive()" style="width: 100%; background: #4285F4; color: white; margin-top: 5px;">G-Drive Cloud</button>

    <div class="sec-head">üì• Importar Media & Web</div>
    <input type="text" id="urlInput" placeholder="URL: YouTube, TikTok, Direct Link..." style="width:100%; padding:10px; border-radius:8px; background:#111; color:white; border:1px solid #444;">
    <button onclick="addFromUrl()" style="width:100%; margin-top:8px;">+ A√ëADIR URL</button>
    <button onclick="fileInput.click()" class="secondary" style="width:100%; margin-top:8px;">üìÅ ARCHIVO LOCAL (3D/GIF/VID)</button>
    <input type="file" id="fileInput" multiple style="display:none">

    <div class="sec-head">üìë Capas de Escena</div>
    <div id="layerList" class="layer-list"></div>

    <div id="editorUI" style="display:none; margin-top:15px; border-top: 1px solid #333; padding-top:15px;">
      <div class="sec-head">üìç Proyecci√≥n & Superficie</div>
      <select id="projSelect" style="width:100%; padding:8px; border-radius:8px; background:#111; color:white;">
        <option value="plane">Plano 2D (Foto/Video)</option>
        <option value="360_in">360¬∞ Interior (Inmersivo)</option>
        <option value="360_out">360¬∞ Exterior (Orbe)</option>
        <option value="180">Domo 180¬∞ (VR)</option>
        <option value="curved">Cine Curvo</option>
      </select>

      <div class="sec-head">üìè Transformaci√≥n Local</div>
      <div class="row"><label>Escala</label><input type="range" id="scale" min="0.1" max="10" step="0.1"><span class="val" id="v_scale">1.0</span></div>
      <div class="row"><label>Altura Y</label><input type="range" id="posY" min="-5" max="5" step="0.1"><span class="val" id="v_posY">1.6</span></div>
      
      <div class="sec-head">ü•Ω Realidad Mixta</div>
      <div class="row"><label><input type="checkbox" id="checkOcclusion"> Oclusi√≥n Depth API</label></div>
      <div class="row"><label><input type="checkbox" id="checkGrid" checked> Grilla Hologr√°fica</label></div>
      
      <div class="row" style="margin-top:15px;">
        <button class="danger" onclick="deleteActive()">üóëÔ∏è Borrar</button>
        <button onclick="resetTransform()">üéØ Reset</button>
      </div>
    </div>
  </div>
<script type="importmap">
  { "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
  }}
</script>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { TransformControls } from 'three/addons/controls/TransformControls.js';
import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

let scene, camera, renderer, cssRenderer, xrSession;
let objects = [], activeId = null;
let transformControl, orbit, grid;
let occlusionEnabled = false;

// ======= SHADER DE MEDIA AVANZADO (CHROMA + CORRECCI√ìN) =======
const mediaFrag = `
uniform sampler2D map;
uniform vec3 keyColor;
uniform float similarity, smoothness, opacity;
uniform float brightness, contrast;
varying vec2 vUv;
void main() {
  vec4 tex = texture2D(map, vUv);
  vec3 col = tex.rgb;
  float d = distance(col, keyColor);
  float mask = smoothstep(similarity, similarity + smoothness, d);
  col += brightness;
  col = (col - 0.5) * contrast + 0.5;
  gl_FragColor = vec4(col, tex.a * mask * opacity);
  if(gl_FragColor.a < 0.05) discard;
}`;

// ======= INICIALIZACI√ìN DEL MOTOR =======
function init() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.01, 1000);
  camera.position.set(0, 1.6, 3);

  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('c'), antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  renderer.xr.setReferenceSpaceType('local-floor'); // Coordenadas reales Quest

  cssRenderer = new CSS3DRenderer();
  cssRenderer.setSize(window.innerWidth, window.innerHeight);
  document.getElementById('css3d').appendChild(cssRenderer.domElement);

  orbit = new OrbitControls(camera, renderer.domElement);
  orbit.target.set(0, 1.6, 0);

  grid = new THREE.GridHelper(20, 40, 0xffaa00, 0x222222);
  scene.add(grid);

  transformControl = new TransformControls(camera, renderer.domElement);
  transformControl.addEventListener('dragging-changed', (e) => orbit.enabled = !e.value);
  scene.add(transformControl);

  setupXR();
  animate();
}

// ======= GESTI√ìN DE OCLUSI√ìN (DEPTH API) =======
async function setupXR() {
  const btn = document.getElementById('vrBtn');
  if ('xr' in navigator) {
    const supported = await navigator.xr.isSessionSupported('immersive-ar');
    if (supported) {
      btn.style.display = 'block';
      btn.onclick = async () => {
        const session = await navigator.xr.requestSession('immersive-ar', {
          requiredFeatures: ['local-floor'],
          optionalFeatures: ['depth-sensing', 'dom-overlay'],
          domOverlay: { root: document.body },
          depthSensing: { usagePreference: ['gpu-optimized'], dataFormatPreference: ['luminance-alpha'] }
        });
        renderer.xr.setSession(session);
        setMode(true);
      };
    }
  }
}


  <button id="vrBtn">ENTRAR EN REALIDAD MIXTA</button>
// ======= CARGA DE ARCHIVOS MULTI-FORMATO =======
async function handleFile(file) {
  const url = URL.createObjectURL(file);
  const name = file.name.toLowerCase();
  
  if (name.endsWith('.glb') || name.endsWith('.gltf')) {
    const loader = new GLTFLoader();
    loader.load(url, (gltf) => add3DObject(gltf.scene, file.name));
  } else if (file.type.startsWith('video')) {
    createVideoSurface(url, file.name);
  } else if (name.endsWith('.gif')) {
    loadGif(file); // Implementaci√≥n omggif v30
  } else if (file.type.startsWith('image')) {
    createImageSurface(url, file.name);
  }
}

// ======= SUPERFICIES DE PROYECCI√ìN (5+ TIPOS) =======
function createMesh(type, texture) {
  let geo;
  switch(type) {
    case '360_in': geo = new THREE.SphereGeometry(20, 64, 32); break;
    case '360_out': geo = new THREE.SphereGeometry(1, 64, 32); break;
    case '180': geo = new THREE.SphereGeometry(20, 64, 32, 0, Math.PI * 2, 0, Math.PI / 2); break;
    case 'curved': geo = new THREE.CylinderGeometry(5, 5, 3, 32, 1, true, 0, Math.PI / 2); break;
    default: geo = new THREE.PlaneGeometry(1.77, 1);
  }
  const mat = new THREE.MeshBasicMaterial({ map: texture, transparent: true, side: THREE.DoubleSide });
  if (type === '360_in') mat.side = THREE.BackSide;
  return new THREE.Mesh(geo, mat);
}

// ======= INTEGRACI√ìN WEB (YOUTUBE / TIKTOK) =======
function addYouTube(id) {
  const div = document.createElement('div');
  div.style.width = '480px'; div.style.height = '360px';
  div.innerHTML = `<iframe width="480" height="360" src="https://www.youtube.com/embed/${id}" frameborder="0"></iframe>`;
  
  const obj = new CSS3DObject(div);
  obj.position.set(0, 1.6, -2);
  obj.scale.set(0.01, 0.01, 0.01);
  scene.add(obj);
  
  // Mesh invisible para que el Raycaster pueda seleccionar el video en el espacio 3D
  const picker = new THREE.Mesh(new THREE.PlaneGeometry(4.8, 3.6), new THREE.MeshBasicMaterial({opacity: 0, transparent: true}));
  picker.position.copy(obj.position);
  scene.add(picker);
}

// ======= RENDER LOOP =======
function animate() {
  renderer.setAnimationLoop((t, frame) => {
    orbit.update();
    // Actualizar GIFs y Texturas de Video aqu√≠
    if (occlusionEnabled && frame) {
      // L√≥gica de oclusi√≥n real extra√≠da de v6.0 FIX
    }
    renderer.render(scene, camera);
    cssRenderer.render(scene, camera);
  });
}

init();
</script>
</body>
</html>
